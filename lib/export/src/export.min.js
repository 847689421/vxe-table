"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var defaultHtmlStyle="body{margin:0}table{font-size:14px;text-align:left;border-width:1px 0 0 1px}table,td,th{border-style:solid;border-color:#e8eaec}tfoot,thead{background-color:#f8f8f9}td,th{padding:.5em .4em;border-width:0 1px 1px 0}.tree-icon-wrapper{position:relative;display:inline-block;vertical-align:middle;width:1.2em}.tree-icon{position:absolute;top:-.3em;left:0;width:0;height:0;border-style:solid;border-width:.5em;border-top-color:#939599;border-right-color:transparent;border-bottom-color:transparent;border-left-color:transparent}.tree-node{text-align:left}.tree-indent{display:inline-block}",impForm=document.createElement("form"),impInput=document.createElement("input");function hasTreeChildren(e,t){var o=e.treeOpts;return t[o.children]&&t[o.children].length}function getContent(e,t,o,n){switch(t.type){case"csv":return toCsv(e,t,o,n);case"txt":return toTxt(e,t,o,n);case"html":return toHtml(e,t,o,n);case"xml":return toXML(e,t,o,n)}return""}function getSeq(e,t,o,n,a){var r=e.seqOpts,i=r.seqMethod||n.indexMethod;return i?i({row:t,rowIndex:o,column:n,columnIndex:a}):(r.startIndex||e.startIndex)+o+1}function getHeaderTitle(e,t){return(e.original?t.property:t.getTitle())||""}function toCsv(a,t,e,o){var r=t.original,i="\ufeff";if(t.isHeader&&(i+=e.map(function(e){return'"'.concat(getHeaderTitle(t,e),'"')}).join(",")+"\n"),o.forEach(function(o,n){r||t.data?i+=e.map(function(e,t){return"seq"===e.type||"index"===e.type?'"'.concat(getSeq(a,o,n,e,t),'"'):'"'.concat(_tools.UtilTools.getCellValue(o,e)||"",'"')}).join(",")+"\n":i+=e.map(function(e){return'"'.concat(o[e.id],'"')}).join(",")+"\n"}),t.isFooter){var n=a.footerData;(t.footerFilterMethod?n.filter(t.footerFilterMethod):n).forEach(function(t){i+=e.map(function(e){return'"'.concat(t[a.$getColumnIndex(e)]||"",'"')}).join(",")+"\n"})}return i}function toTxt(a,t,e,o){var r=t.original,i="";if(t.isHeader&&(i+=e.map(function(e){return"".concat(getHeaderTitle(t,e))}).join("\t")+"\n"),o.forEach(function(o,n){r||t.data?i+=e.map(function(e,t){return"seq"===e.type||"index"===e.type?"".concat(getSeq(a,o,n,e,t)):"".concat(_tools.UtilTools.getCellValue(o,e)||"")}).join("\t")+"\n":i+=e.map(function(e){return"".concat(o[e.id])}).join("\t")+"\n"}),t.isFooter){var n=a.footerData;(t.footerFilterMethod?n.filter(t.footerFilterMethod):n).forEach(function(t){i+=e.map(function(e){return"".concat(t[a.$getColumnIndex(e)]||"")}).join(",")+"\n"})}return i}function toHtml(l,t,c,e){var s=l.treeConfig,u=l.treeOpts,o=l.tableFullData,d=t.original,f=["<html>","<head>",'<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,minimal-ui"><title>'.concat(t.sheetName,"</title>"),"<style>".concat(t.style||defaultHtmlStyle,"</style>"),"</head>","<body>",'<table border="1" cellspacing="0" cellpadding="0">',"<colgroup>".concat(c.map(function(e){return'<col width="'.concat(e.renderWidth,'">')}).join(""),"</colgroup>")].join("");if(t.isHeader&&(f+="<thead><tr>".concat(c.map(function(e){return"<th>".concat(getHeaderTitle(t,e),"</th>")}).join(""),"</tr></thead>")),e.length&&(f+="<tbody>",s?_xeUtils.default.eachTree(t.data?e:o,function(a,r,e,t,o,i){f+="<tr>",f+=d?c.map(function(e,t){var o="";if(o="seq"===e.type||"index"===e.type?getSeq(l,a,r,e,t):_tools.UtilTools.getCellValue(a,e)||"",s&&e.treeNode){var n="";return hasTreeChildren(l,a)&&(n='<i class="tree-icon"></i>'),'<td class="tree-node"><span class="tree-indent" style="width: '.concat((i.length-1)*u.indent,'px"></span><span class="tree-icon-wrapper">').concat(n,"</span>").concat(o,"</td>")}return"<td>".concat(o,"</td>")}).join(""):c.map(function(e){if(s&&e.treeNode){var t="";return a._hasChild&&(t='<i class="tree-icon"></i>'),'<td class="tree-node"><span class="tree-indent" style="width: '.concat((i.length-1)*u.indent,'px"></span><span class="tree-icon-wrapper">').concat(t,"</span>").concat(a[e.id],"</td>")}return"<td>".concat(a[e.id],"</td>")}).join(""),f+="</tr>"},u):e.forEach(function(n,a){f+="<tr>",d||t.data?f+=c.map(function(e,t){var o="";return o="seq"===e.type||"index"===e.type?getSeq(l,n,a,e,t):_tools.UtilTools.getCellValue(n,e)||"","<td>".concat(o,"</td>")}).join(""):f+=c.map(function(e){return"<td>".concat(n[e.id],"</td>")}).join(""),f+="</tr>"}),f+="</tbody>"),t.isFooter){var n=l.footerData,a=t.footerFilterMethod?n.filter(t.footerFilterMethod):n;a.length&&(f+="<tfoot>",a.forEach(function(t){f+="<tr>".concat(c.map(function(e){return"<td>".concat(t[l.$getColumnIndex(e)]||"","</td>")}).join(""),"</tr>")}),f+="</tfoot>")}return f+"</table></body></html>"}function toXML(a,t,e,o){var r=t.original,i=['<?xml version="1.0"?>','<?mso-application progid="Excel.Sheet"?>','<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:html="http://www.w3.org/TR/REC-html40">','<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">',"<Version>16.00</Version>","</DocumentProperties>",'<ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel">',"<WindowHeight>7920</WindowHeight>","<WindowWidth>21570</WindowWidth>","<WindowTopX>32767</WindowTopX>","<WindowTopY>32767</WindowTopY>","<ProtectStructure>False</ProtectStructure>","<ProtectWindows>False</ProtectWindows>","</ExcelWorkbook>",'<Worksheet ss:Name="'.concat(t.sheetName,'">'),"<Table>",e.map(function(e){return'<Column ss:Width="'.concat(e.renderWidth,'"/>')}).join("")].join("");if(t.isHeader&&(i+="<Row>".concat(e.map(function(e){return'<Cell><Data ss:Type="String">'.concat(getHeaderTitle(t,e),"</Data></Cell>")}).join(""),"</Row>")),o.forEach(function(o,n){i+="<Row>",r||t.data?i+=e.map(function(e,t){return"seq"===e.type||"index"===e.type?'<Cell><Data ss:Type="String">'.concat(getSeq(a,o,n,e,t),"</Data></Cell>"):'<Cell><Data ss:Type="String">'.concat(_tools.UtilTools.getCellValue(o,e)||"","</Data></Cell>")}).join(""):i+=e.map(function(e){return'<Cell><Data ss:Type="String">'.concat(o[e.id],"</Data></Cell>")}).join(""),i+="</Row>"}),t.isFooter){var n=a.footerData;(t.footerFilterMethod?n.filter(t.footerFilterMethod):n).forEach(function(t){i+="<Row>".concat(e.map(function(e){return'<Cell><Data ss:Type="String">'.concat(t[a.$getColumnIndex(e)||""],"</Data></Cell>")}).join(""),"</Row>")})}return"".concat(i,"</Table></Worksheet></Workbook>")}function downloadFile(e,t,o){var n=t.filename,a=t.type,r=t.download,i="".concat(n,".").concat(a);if(window.Blob){var l=new Blob([o],{type:"text/".concat(a)});if(!r)return Promise.resolve({type:a,content:o,blob:l});if(navigator.msSaveBlob)navigator.msSaveBlob(l,i);else{var c=document.createElement("a");c.target="_blank",c.download=i,c.href=URL.createObjectURL(l),document.body.appendChild(c),c.click(),document.body.removeChild(c)}!1!==t.message&&e.$XModal.message({message:_conf.default.i18n("vxe.table.expSuccess"),status:"success"})}else _tools.UtilTools.error("vxe.error.notExp")}function getLabelData(a,e,t){var r=a.treeConfig;return t.map(function(o){var n={_hasChild:r&&hasTreeChildren(a,o)};return e.forEach(function(e){var t=_tools.DomTools.getCell(a,{row:o,column:e});n[e.id]=t?t.innerText.trim():""}),n})}function getExportData(e,t,o,n){var a=t.columns?t.columns:n,r=t.data||o;return t.columnFilterMethod&&(a=a.filter(t.columnFilterMethod)),t.dataFilterMethod&&(r=r.filter(t.dataFilterMethod)),{columns:a,datas:t.original||t.data?r:getLabelData(e,a,r)}}function replaceDoubleQuotation(e){return e.replace(/^"/,"").replace(/"$/,"")}function parseCsv(e,t){var o=t.split("\n"),n=[],a=[];if(o.length){var r=o.slice(1);o[0].split(",").forEach(function(e){var t=replaceDoubleQuotation(e);t&&n.push(t)}),r.forEach(function(e){if(e){var o={};e.split(",").forEach(function(e,t){o[n[t]]=replaceDoubleQuotation(e)}),a.push(o)}})}return{fields:n,rows:a}}function parseTxt(e,t){var o=t.split("\n"),n=[],a=[];if(o.length){var r=o.slice(1);o[0].split("\t").forEach(function(e){e&&n.push(e)}),r.forEach(function(e){if(e){var o={};e.split("\t").forEach(function(e,t){o[n[t]]=replaceDoubleQuotation(e)}),a.push(o)}})}return{fields:n,rows:a}}function parseHTML(e,t){var o=getElementsByTagName((new DOMParser).parseFromString(t,"text/html"),"body"),n=[],a=[];if(o.length){var r=getElementsByTagName(o[0],"table");if(r.length){var i=getElementsByTagName(r[0],"thead");if(i.length){_xeUtils.default.arrayEach(getElementsByTagName(i[0],"tr"),function(e){_xeUtils.default.arrayEach(getElementsByTagName(e,"th"),function(e){var t=e.textContent;t&&n.push(t)})});var l=getElementsByTagName(r[0],"tbody");l.length&&_xeUtils.default.arrayEach(getElementsByTagName(l[0],"tr"),function(e){var o={};_xeUtils.default.arrayEach(getElementsByTagName(e,"td"),function(e,t){o[n[t]]=e.textContent||""}),a.push(o)})}}}return{fields:n,rows:a}}function parseXML(e,t){var o=getElementsByTagName((new DOMParser).parseFromString(t,"application/xml"),"Worksheet"),a=[],r=[];if(o.length){var n=getElementsByTagName(o[0],"Table");if(n.length){var i=getElementsByTagName(n[0],"Row");i.length&&(_xeUtils.default.arrayEach(getElementsByTagName(i[0],"Cell"),function(e){var t=e.textContent;t&&a.push(t)}),_xeUtils.default.arrayEach(i,function(e,t){if(t){var o={},n=getElementsByTagName(e,"Cell");_xeUtils.default.arrayEach(n,function(e,t){o[a[t]]=e.textContent}),r.push(o)}}))}}return{fields:a,rows:r}}function getElementsByTagName(e,t){return e.getElementsByTagName(t)}function checkImportData(e,t,o){var n=[];return e.forEach(function(e){var t=e.property;t&&n.push(t)}),n.every(function(e){return _xeUtils.default.includes(t,e)})}impForm.className="vxe-table--import-form",impInput.name="file",impInput.type="file",impForm.appendChild(impInput);var _default={handleExport:function(e,t,o,n){var a=getExportData(e,t,n,o),r=a.columns,i=a.datas;return e.preventEvent(null,"event.export",{$table:e,options:t,columns:r,datas:i},function(){return downloadFile(e,t,getContent(e,t,r,i))})},handleImport:function(t,e,o){var n=t.tableFullColumn,a=t._importResolve,r={fields:[],rows:[]};switch(o.type){case"csv":r=parseCsv(n,e);break;case"txt":r=parseTxt(n,e);break;case"html":r=parseHTML(n,e);break;case"xml":r=parseXML(n,e)}var i=r.fields,l=r.rows,c=checkImportData(n,i,l);c?(t.createData(l).then(function(e){"append"===o.mode?t.insertAt(e,-1):t.reloadData(e)}),!1!==o.message&&t.$XModal.message({message:_conf.default.i18n("vxe.table.impSuccess"),status:"success"})):!1!==o.message&&t.$XModal.message({message:_conf.default.i18n("vxe.error.impFields"),status:"error"}),a&&(a(c),t._importResolve=null)}};exports.default=_default;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools"),_vXETable=require("../../v-x-e-table");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _defineProperty(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}var _default2={name:"VxeToolbar",props:{id:String,loading:!1,resizable:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.resizable}},refresh:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.refresh}},exps:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.exps}},setting:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.setting}},buttons:{type:Array,default:function(){return _conf.default.toolbar.buttons}},size:String,data:Array,customs:Array},inject:{$grid:{default:null}},data:function(){return{$table:null,isRefresh:!1,tableFullColumn:[],exportSuffixs:["csv"],exportTypes:[{value:"all",label:"vxe.toolbar.exportAll"},{value:"selected",label:"vxe.toolbar.exportSelected"}],exportStore:{name:"",suffix:"csv",type:"all",optHeader:!0,optIndex:!1},settingStore:{visible:!1}}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},refreshOpts:function(){return Object.assign({},_conf.default.toolbar.refresh,this.refresh)},expsOpts:function(){return Object.assign({},_conf.default.toolbar.exps,this.exps)},resizableOpts:function(){return Object.assign({storageKey:"VXE_TABLE_CUSTOM_COLUMN_WIDTH"},_conf.default.toolbar.resizable,this.resizable)},settingOpts:function(){return Object.assign({storageKey:"VXE_TABLE_CUSTOM_COLUMN_HIDDEN"},_conf.default.toolbar.setting,this.setting)}},created:function(){var t=this,e=this.settingOpts,o=this.id,n=this.customs;if(n&&(this.tableFullColumn=n),e.storage&&!o)return _tools.UtilTools.error("vxe.error.toolbarId");this.$nextTick(function(){t.updateConf(),t.loadStorage()}),_tools.GlobalEvent.on(this,"mousedown",this.handleGlobalMousedownEvent),_tools.GlobalEvent.on(this,"blur",this.handleGlobalBlurEvent)},destroyed:function(){_tools.GlobalEvent.off(this,"mousedown"),_tools.GlobalEvent.off(this,"blur")},render:function(r){var t,s=this,o=this._e,e=this.$scopedSlots,n=this.$grid,i=this.$table,l=this.loading,a=this.settingStore,u=this.refresh,c=this.exps,d=this.setting,f=this.settingOpts,h=this.buttons,p=void 0===h?[]:h,v=this.vSize,b=this.tableFullColumn,g={},x={},m=e.buttons,_=e.tools;return d&&("manual"===f.trigger||("hover"===f.trigger?(g.mouseenter=this.handleMouseenterSettingEvent,g.mouseleave=this.handleMouseleaveSettingEvent,x.mouseenter=this.handleWrapperMouseenterEvent,x.mouseleave=this.handleWrapperMouseleaveEvent):g.click=this.handleClickSettingEvent)),r("div",{class:["vxe-toolbar",(t={},_defineProperty(t,"size--".concat(v),v),_defineProperty(t,"is--loading",l),t)]},[r("div",{class:"vxe-button--wrapper"},m?m.call(this,{$grid:n,$table:i},r):p.map(function(e){return!1===e.visible?o():r("vxe-button",{on:{click:function(t){return s.btnEvent(t,e)}},props:{disabled:e.disabled},scopedSlots:e.dropdowns&&e.dropdowns.length?{default:function(){return _tools.UtilTools.getFuncText(e.name)},dropdowns:function(){return e.dropdowns.map(function(e){return!1===e.visible?o():r("vxe-button",{on:{click:function(t){return s.btnEvent(t,e)}},props:{disabled:e.disabled}},_tools.UtilTools.getFuncText(e.name))})}}:null},_tools.UtilTools.getFuncText(e.name))})),r("div",{class:"vxe-tools--operate"},[c?r("vxe-button",{class:"vxe-export--btn",props:{type:"text",icon:_conf.default.icon.export},on:{click:this.exportEvent}}):null,u?r("vxe-button",{class:"vxe-refresh--btn",props:{type:"text",icon:_conf.default.icon.refresh,loading:this.isRefresh},on:{click:this.refreshEvent}}):null,d?r("div",{class:["vxe-custom--wrapper",{"is--active":a.visible}],ref:"customWrapper"},[r("div",{class:"vxe-custom--setting-btn",on:g},[r("i",{class:_conf.default.icon.custom})]),r("div",{class:"vxe-custom--option-wrapper"},[r("div",{class:"vxe-custom--option",on:x},b.map(function(e){var t=e.property,o=e.visible,n=e.own,i=_tools.UtilTools.getFuncText(n.title||n.label);return t&&i?r("vxe-checkbox",{props:{value:o},attrs:{title:i},on:{change:function(t){e.visible=t,d&&f.immediate&&s.updateSetting()}}},i):null}))])]):null]),_?r("div",{class:"vxe-tools--wrapper"},_.call(this,{$grid:n,$table:i},r)):null])},methods:{updateConf:function(){var t=this.$parent,o=this.data,e=t.$children,n=e.indexOf(this);this.$table=e.find(function(t,e){return t&&t.refreshColumn&&n<e&&(o?t.data===o:"vxe-table"===t.$vnode.componentOptions.tag)})},openSetting:function(){this.settingStore.visible=!0},closeSetting:function(){var t=this.setting,e=this.settingStore;e.visible&&(e.visible=!1,t&&!e.immediate&&this.updateSetting())},loadStorage:function(){var t=this.$grid,e=this.$table,o=this.id,n=this.refresh,i=this.resizable,r=this.setting,s=this.refreshOpts,l=this.resizableOpts,a=this.settingOpts;if(n&&!t&&(s.query||_tools.UtilTools.warn("vxe.error.notFunc",["query"])),i||r){if(!t&&!e)throw new Error(_tools.UtilTools.getLog("vxe.error.barUnableLink"));(t||e).connect({toolbar:this});var u={};if(l.storage){var c=this.getStorageMap(l.storageKey)[o];c&&_xeUtils.default.each(c,function(t,e){u[e]={field:e,resizeWidth:t}})}if(a.storage){var d=this.getStorageMap(a.storageKey)[o];d&&d.split(",").forEach(function(t){u[t]?u[t].visible=!1:u[t]={field:t,visible:!1}})}var f=Object.values(u);this.updateCustoms(f.length?f:this.tableFullColumn)}},updateColumn:function(t){this.tableFullColumn=t},updateCustoms:function(t){var e=this,o=this.$grid,n=this.$table,i=o||n;i&&i.reloadCustoms(t).then(function(t){e.tableFullColumn=t})},getStorageMap:function(t){var e=_conf.default.version,o=_xeUtils.default.toStringJSON(localStorage.getItem(t));return o&&o._v===e?o:{_v:e}},saveColumnHide:function(){var t=this.id,e=this.tableFullColumn,o=this.settingOpts;if(o.storage){var n=this.getStorageMap(o.storageKey),i=e.filter(function(t){return t.property&&!t.visible});n[t]=i.length?i.map(function(t){return t.property}).join(","):void 0,localStorage.setItem(o.storageKey,_xeUtils.default.toJSONString(n))}return this.$nextTick()},saveColumnWidth:function(t){var e=this.id,o=this.tableFullColumn,n=this.resizableOpts;if(n.storage){var i,r=this.getStorageMap(n.storageKey);t||(i=_xeUtils.default.isPlainObject(r[e])?r[e]:{},o.forEach(function(t){var e=t.property,o=t.resizeWidth,n=t.renderWidth;e&&o&&(i[e]=n)})),r[e]=_xeUtils.default.isEmpty(i)?void 0:i,localStorage.setItem(n.storageKey,_xeUtils.default.toJSONString(r))}return this.$nextTick()},hideColumn:function(t){return _tools.UtilTools.warn("vxe.error.delFunc",["hideColumn","table.hideColumn"]),t.visible=!1,this.updateSetting()},showColumn:function(t){return _tools.UtilTools.warn("vxe.error.delFunc",["showColumn","table.showColumn"]),t.visible=!0,this.updateSetting()},resetCustoms:function(){return this.updateSetting()},resetResizable:function(){this.updateResizable(this)},updateResizable:function(t){var e=this.$grid,o=this.$table,n=e||o;return this.saveColumnWidth(t),n.analyColumnWidth(),n.recalculate(!0)},updateSetting:function(){return(this.$grid||this.$table).refreshColumn(),this.saveColumnHide()},handleGlobalMousedownEvent:function(t){_tools.DomTools.getEventTargetNode(t,this.$refs.customWrapper).flag||this.closeSetting()},handleGlobalBlurEvent:function(t){this.closeSetting()},handleClickSettingEvent:function(t){var e=this.settingStore;e.visible=!e.visible},handleMouseenterSettingEvent:function(t){this.settingStore.activeBtn=!0,this.openSetting()},handleMouseleaveSettingEvent:function(t){var e=this,o=this.settingStore;o.activeBtn=!1,setTimeout(function(){o.activeBtn||o.activeWrapper||e.closeSetting()},300)},handleWrapperMouseenterEvent:function(t){this.settingStore.activeWrapper=!0,this.openSetting()},handleWrapperMouseleaveEvent:function(t){var e=this,o=this.settingStore;o.activeWrapper=!1,setTimeout(function(){o.activeBtn||o.activeWrapper||e.closeSetting()},300)},refreshEvent:function(){var t=this,e=this.$grid,o=this.refreshOpts;this.isRefresh||(o.query?(this.isRefresh=!0,o.query().catch(function(t){return t}).then(function(){t.isRefresh=!1})):e&&(this.isRefresh=!0,e.commitProxy("reload").catch(function(t){return t}).then(function(){t.isRefresh=!1})))},btnEvent:function(t,e){var o=this.$grid,n=this.$table,i=e.code;if(i)if(o)o.triggerToolbarBtnEvent(e,t);else{var r=_vXETable.Buttons.get(i),s={code:i,button:e,$grid:o,$table:n};r&&r.call(this,s,t),_tools.UtilTools.emitEvent(this,"button-click",[s,t])}},exportEvent:function(){var t=this.$grid,e=this.$table,n=this.vSize,i=this.exportStore,r=this.exportSuffixs,s=this.exportTypes,l=t||e,o=l.getSelectRecords();Object.assign(i,{name:"",type:o.length?"selected":"all",optHeader:!0,optIndex:!1}),this.$XModal({title:_conf.default.i18n("vxe.toolbar.exportTitle"),width:520,mask:!0,lockView:!0,showFooter:!1,maskClosable:!0,size:n,slots:{default:function(t,e){var o=t.$modal;return[e("div",{class:"vxe-export--panel"},[e("table",[e("tr",[e("td",_conf.default.i18n("vxe.toolbar.exportName")),e("td",[e("input",{attrs:{type:"text",placeholder:_conf.default.i18n("vxe.toolbar.exportNamePlaceholder")},domProps:{value:i.name},on:{input:function(t){i.name=t.target.value}}})])]),e("tr",[e("td",_conf.default.i18n("vxe.toolbar.exportType")),e("td",[e("select",{on:{change:function(t){i.type=t.target.value}}},s.map(function(t){return e("option",{attrs:{value:t.value},domProps:{selected:i.type===t.value}},_conf.default.i18n(t.label))}))])]),e("tr",[e("td",_conf.default.i18n("vxe.toolbar.exportSuffix")),e("td",[e("select",{on:{change:function(t){i.type=t.target.value}}},r.map(function(t){return e("option",{attrs:{value:t},domProps:{selected:i.suffix===t}},t)}))])]),e("tr",[e("td",_conf.default.i18n("vxe.toolbar.exportOpts")),e("td",[e("vxe-checkbox",{model:{value:i.optHeader,callback:function(t){i.optHeader=t}}},_conf.default.i18n("vxe.toolbar.exportOptHeader")),e("vxe-checkbox",{model:{value:i.optIndex,callback:function(t){i.optIndex=t}}},_conf.default.i18n("vxe.toolbar.exportOptIndex"))])])]),e("div",{class:"vxe-export--panel-btns"},[e("vxe-button",{props:{type:"primary",size:n},on:{click:function(){var t={filename:i.name||_conf.default.i18n("vxe.toolbar.exportTitle"),isHeader:i.optHeader};i.optIndex&&(t.columnFilterMethod=function(t){return"index"===t.type||t.property&&-1===["checkbox","selection","radio"].indexOf(t.type)}),l.exportCsv(t),o.close()}}},_conf.default.i18n("vxe.toolbar.exportConfirm"))])])]}}})}}};exports.default=_default2;
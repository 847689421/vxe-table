"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function renderButton(t,e,n,i){return t("vxe-button",{on:{click:function(t){return e.btnEvent(t,n,i)}}},_tools.UtilTools.getFuncText(n.name))}var _default2={name:"VxeToolbar",props:{id:String,resizable:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.resizable}},refresh:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.refresh}},setting:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.setting}},buttons:{type:Array,default:function(){return _conf.default.toolbar.buttons}},size:String,data:Array,customs:Array},inject:{$grid:{default:null}},data:function(){return{$table:null,isRefresh:!1,tableFullColumn:[],settingStore:{visible:!1}}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},refreshOpts:function(){return Object.assign({},_conf.default.toolbar.refresh,this.refresh)},resizableOpts:function(){return Object.assign({storageKey:"VXE_TABLE_CUSTOM_COLUMN_WIDTH"},_conf.default.toolbar.resizable,this.resizable)},settingOpts:function(){return Object.assign({storageKey:"VXE_TABLE_CUSTOM_COLUMN_HIDDEN"},_conf.default.toolbar.setting,this.setting)}},created:function(){var t=this,e=this.settingOpts,n=this.id,i=this.customs;if(i&&(this.tableFullColumn=i),e.storage&&!n)throw new Error("[vxe-table] Toolbar must have a unique primary id.");this.$nextTick(function(){t.updateConf(),t.loadStorage()}),_tools.GlobalEvent.on(this,"mousedown",this.handleGlobalMousedownEvent),_tools.GlobalEvent.on(this,"blur",this.handleGlobalBlurEvent)},destroyed:function(){_tools.GlobalEvent.off(this,"mousedown"),_tools.GlobalEvent.off(this,"blur")},render:function(s){var r=this,t=this.$scopedSlots,e=this.$grid,n=this.$table,i=this.settingStore,o=this.refresh,a=this.setting,l=this.settingOpts,u=this.buttons,c=void 0===u?[]:u,h=this.vSize,f=this.tableFullColumn,d={},v={},p=t.buttons;return a&&("manual"===l.trigger||("hover"===l.trigger?(d.mouseenter=this.handleMouseenterSettingEvent,d.mouseleave=this.handleMouseleaveSettingEvent,v.mouseenter=this.handleWrapperMouseenterEvent,v.mouseleave=this.handleWrapperMouseleaveEvent):d.click=this.handleClickSettingEvent)),s("div",{class:["vxe-toolbar",_defineProperty({},"size--".concat(h),h)]},[s("div",{class:"vxe-button--wrapper"},p?p.call(e||n||this,{$grid:e,$table:n},s):c.map(function(e){return e.children&&e.children.length?s("div",{class:["vxe-button--group",_defineProperty({},"size--".concat(h),h)]},[s("vxe-button",{on:{click:function(t){return!!e.code&&r.btnEvent(t,e)},mouseenter:r.mouseenterBtnEvent,mouseleave:r.mouseleaveBtnEvent}},[s("span",_tools.UtilTools.getFuncText(e.name)),s("i",{class:"vxe-button--group-arrow ".concat(_conf.default.icon.caretBottom)})]),s("div",{class:"vxe-button--group-wrapper",on:{mouseenter:r.mouseenterBtnEvent,mouseleave:r.mouseleaveBtnEvent}},e.children.map(function(t){return renderButton(s,r,t,1)}))]):renderButton(s,r,e)})),a?s("div",{class:["vxe-custom--wrapper",{"is--active":i.visible}],ref:"customWrapper"},[s("div",{class:"vxe-custom--setting-btn",on:d},[s("i",{class:_conf.default.icon.custom})]),s("div",{class:"vxe-custom--option-wrapper"},[s("div",{class:"vxe-custom--option",on:v},f.map(function(e){var t=e.property,n=e.visible,i=e.own,o=_tools.UtilTools.getFuncText(i.title||i.label);return t&&o?s("vxe-checkbox",{props:{value:n},on:{change:function(t){e.visible=t,a&&l.immediate&&r.updateSetting()}}},o):null}))])]):null,o?s("div",{class:"vxe-refresh--wrapper"},[s("div",{class:"vxe-refresh--btn",on:{click:this.refreshEvent}},[s("i",{class:[_conf.default.icon.refresh,{roll:this.isRefresh}]})])]):null])},methods:{updateConf:function(){var t=this.$parent,n=this.data,e=t.$children,i=e.indexOf(this);this.$table=e.find(function(t,e){return t&&t.refreshColumn&&i<e&&(n?t.data===n:"vxe-table"===t.$vnode.componentOptions.tag)})},openSetting:function(){this.settingStore.visible=!0},closeSetting:function(){var t=this.setting,e=this.settingStore;e.visible&&(e.visible=!1,t&&!e.immediate&&this.updateSetting())},loadStorage:function(){var t=this.$grid,e=this.$table,n=this.id,i=this.refresh,o=this.resizable,s=this.setting,r=this.refreshOpts,a=this.resizableOpts,l=this.settingOpts;if(i&&!t&&(r.query||console.warn("[vxe-toolbar] refresh.query function does not exist")),o||s){if(!t&&!e)throw new Error("[vxe-toolbar] Not found vxe-table.");(t||e).connect({toolbar:this});var u={};if(a.storage){var c=this.getStorageMap(a.storageKey)[n];c&&_xeUtils.default.each(c,function(t,e){u[e]={field:e,resizeWidth:t}})}if(l.storage){var h=this.getStorageMap(l.storageKey)[n];h&&h.split(",").forEach(function(t){u[t]?u[t].visible=!1:u[t]={field:t,visible:!1}})}var f=Object.values(u);this.updateCustoms(f.length?f:this.tableFullColumn)}},updateColumn:function(t){this.tableFullColumn=t},updateCustoms:function(t){var e=this,n=this.$grid,i=this.$table,o=n||i;o&&o.reloadCustoms(t).then(function(t){e.tableFullColumn=t})},getStorageMap:function(t){var e=_conf.default.version,n=_xeUtils.default.toStringJSON(localStorage.getItem(t));return n&&n._v===e?n:{_v:e}},saveColumnHide:function(){var t=this.id,e=this.tableFullColumn,n=this.settingOpts;if(n.storage){var i=this.getStorageMap(n.storageKey),o=e.filter(function(t){return t.property&&!t.visible});i[t]=o.length?o.map(function(t){return t.property}).join(","):void 0,localStorage.setItem(n.storageKey,_xeUtils.default.toJSONString(i))}return this.$nextTick()},saveColumnWidth:function(t){var e=this.id,n=this.tableFullColumn,i=this.resizableOpts;if(i.storage){var o,s=this.getStorageMap(i.storageKey);t||(o=_xeUtils.default.isPlainObject(s[e])?s[e]:{},n.forEach(function(t){var e=t.property,n=t.resizeWidth,i=t.renderWidth;e&&n&&(o[e]=i)})),s[e]=_xeUtils.default.isEmpty(o)?void 0:o,localStorage.setItem(i.storageKey,_xeUtils.default.toJSONString(s))}return this.$nextTick()},hideColumn:function(t){return console.warn("[vxe-table] The function hideColumn is deprecated"),t.visible=!1,this.updateSetting()},showColumn:function(t){return console.warn("[vxe-table] The function showColumn is deprecated"),t.visible=!0,this.updateSetting()},resetCustoms:function(){return this.updateSetting()},resetResizable:function(){this.updateResizable(this)},updateResizable:function(t){var e=this.$grid,n=this.$table,i=e||n;return this.saveColumnWidth(t),i.analyColumnWidth(),i.recalculate(!0)},updateSetting:function(){return(this.$grid||this.$table).refreshColumn(),this.saveColumnHide()},handleGlobalMousedownEvent:function(t){_tools.DomTools.getEventTargetNode(t,this.$refs.customWrapper).flag||this.closeSetting()},handleGlobalBlurEvent:function(t){this.closeSetting()},handleClickSettingEvent:function(t){var e=this.settingStore;e.visible=!e.visible},handleMouseenterSettingEvent:function(t){this.settingStore.activeBtn=!0,this.openSetting()},handleMouseleaveSettingEvent:function(t){var e=this,n=this.settingStore;n.activeBtn=!1,setTimeout(function(){n.activeBtn||n.activeWrapper||e.closeSetting()},300)},handleWrapperMouseenterEvent:function(t){this.settingStore.activeWrapper=!0,this.openSetting()},handleWrapperMouseleaveEvent:function(t){var e=this,n=this.settingStore;n.activeWrapper=!1,setTimeout(function(){n.activeBtn||n.activeWrapper||e.closeSetting()},300)},refreshEvent:function(){var t=this,e=this.$grid,n=this.refreshOpts;this.isRefresh||(e?(this.isRefresh=!0,e.commitProxy("reload").catch(function(t){return t}).then(function(){t.isRefresh=!1})):n.query&&(this.isRefresh=!0,n.query().catch(function(t){return t}).then(function(){t.isRefresh=!1})))},btnEvent:function(t,e,n){var i=this.$grid;if(i){if(n){var o=t.currentTarget.parentNode.parentNode;o.dataset.active="N",_tools.DomTools.removeClass(o,"is--active")}i.commitProxy(e.code),_tools.UtilTools.emitEvent(i,"toolbar-button-click",[{button:e,$grid:i},t])}},mouseenterBtnEvent:function(t){var e=t.currentTarget.parentNode;e.dataset.active="Y",_tools.DomTools.addClass(e,"is--active")},mouseleaveBtnEvent:function(t){var e=t.currentTarget.parentNode;e.dataset.active="N",setTimeout(function(){"Y"!==e.dataset.active&&_tools.DomTools.removeClass(e,"is--active")},300)}}};exports.default=_default2;
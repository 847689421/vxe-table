"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _defineProperty(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}var _default2={name:"VxeToolbar",props:{id:String,resizable:Object,setting:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.setting}},buttons:{type:Array,default:function(){return _conf.default.toolbar.buttons}},size:String,data:Array,customs:Array},inject:{$grid:{default:null}},data:function(){return{tableCustoms:[],settingStore:{visible:!1}}},computed:{$table:function(){var t=this.$parent,i=this.data,e=t.$children,n=e.indexOf(this);return e.find(function(t,e){return t&&t.refreshColumn&&n<e&&(i?t.data===i:"vxe-table"===t.$vnode.componentOptions.tag)})},vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},resizableOpts:function(){return Object.assign({storageKey:"VXE_TABLE_CUSTOM_COLUMN_WIDTH"},_conf.default.toolbar.resizable,this.resizable)},settingOpts:function(){return Object.assign({storageKey:"VXE_TABLE_CUSTOM_COLUMN_HIDDEN"},_conf.default.toolbar.setting,this.setting)}},created:function(){var t=this,e=this.settingOpts,i=this.id,n=this.customs;if(n&&(this.tableCustoms=n),e.storage&&!i)throw new Error("[vxe-table] Toolbar must have a unique primary id.");this.$nextTick(function(){return t.loadStorage()}),_tools.GlobalEvent.on(this,"mousedown",this.handleGlobalMousedownEvent),_tools.GlobalEvent.on(this,"blur",this.handleGlobalBlurEvent)},destroyed:function(){_tools.GlobalEvent.off(this,"mousedown"),_tools.GlobalEvent.off(this,"blur")},render:function(o){var r=this,t=this.$scopedSlots,e=this.settingStore,a=this.setting,i=this.buttons,n=void 0===i?[]:i,s=this.vSize,l=this.tableCustoms,u={},c={},h=t.buttons;return a&&("manual"===a.trigger||("hover"===a.trigger?(u.mouseenter=this.handleMouseenterSettingEvent,u.mouseleave=this.handleMouseleaveSettingEvent,c.mouseenter=this.handleWrapperMouseenterEvent,c.mouseleave=this.handleWrapperMouseleaveEvent):u.click=this.handleClickSettingEvent)),o("div",{class:["vxe-toolbar",_defineProperty({},"size--".concat(s),s)]},[o("div",{class:"vxe-button--wrapper"},h?h():n.map(function(e){return o("vxe-button",{on:{click:function(t){return r.btnEvent(e,t)}}},_xeUtils.default.isFunction(e.name)?e.name():e.name)})),a?o("div",{class:["vxe-custom--wrapper",{"is--active":e.visible}],ref:"customWrapper"},[o("div",{class:"vxe-custom--setting-btn",on:u},[o("i",{class:"vxe-icon--menu"})]),o("div",{class:"vxe-custom--option-wrapper"},[o("div",{class:"vxe-custom--option",on:c},l.map(function(e){var t=e.property,i=e.visible,n=e.own,s=n.title||n.label;return t&&s?o("vxe-checkbox",{props:{value:i},on:{change:function(t){e.visible=t,a&&a.immediate&&r.updateSetting()}}},s):null}))])]):null])},methods:{openSetting:function(){this.settingStore.visible=!0},closeSetting:function(){var t=this.setting,e=this.settingStore;e.visible&&(e.visible=!1,t&&!t.immediate&&this.updateSetting())},loadStorage:function(){var t=this.$grid,e=this.$table,i=this.id,n=this.resizable,s=this.setting,o=this.resizableOpts,r=this.settingOpts;if(n||s){if(!t&&!e)throw new Error("[vxe-toolbar] Not found vxe-table.");(t||e).connect({toolbar:this});var a={};if(o.storage){var l=this.getStorageMap(o.storageKey)[i];l&&_xeUtils.default.each(l,function(t,e){a[e]={field:e,resizeWidth:t}})}if(r.storage){var u=this.getStorageMap(r.storageKey)[i];u&&u.split(",").forEach(function(t){a[t]?a[t].visible=!1:a[t]={field:t,visible:!1}})}var c=Object.values(a);this.updateCustoms(c.length?c:this.tableCustoms)}},updateCustoms:function(t){var e=this,i=this.$grid,n=this.$table,s=i||n;s&&s.reloadCustoms(t).then(function(t){e.tableCustoms=t})},getStorageMap:function(t){var e=_conf.default.version,i=_xeUtils.default.toStringJSON(localStorage.getItem(t));return i&&i._v===e?i:{_v:e}},saveColumnHide:function(){var t=this.id,e=this.tableCustoms,i=this.settingOpts;if(i.storage){var n=this.getStorageMap(i.storageKey),s=e.filter(function(t){return t.property&&!t.visible});n[t]=s.length?s.map(function(t){return t.property}).join(","):void 0,localStorage.setItem(i.storageKey,_xeUtils.default.toJSONString(n))}return this.$nextTick()},saveColumnWidth:function(t){var e=this.id,i=this.tableCustoms,n=this.resizableOpts;if(n.storage){var s,o=this.getStorageMap(n.storageKey);t||(s=_xeUtils.default.isPlainObject(o[e])?o[e]:{},i.forEach(function(t){var e=t.property,i=t.isResizable,n=t.renderWidth;e&&i&&(s[e]=n)})),o[e]=_xeUtils.default.isEmpty(s)?void 0:s,localStorage.setItem(n.storageKey,_xeUtils.default.toJSONString(o))}return this.$nextTick()},resetStorage:function(){var t=this.$grid,e=this.$table,i=t||e;return this.tableCustoms.forEach(function(t){t.resizeWidth=0,t.visible=!0}),i.analyColumnWidth(),this.saveColumnWidth(!0),this.updateSetting(),i.recalculate(!0)},hideColumn:function(t){return t.visible=!1,this.updateSetting()},showColumn:function(t){var e=this.tableCustoms;return t?t.visible=!0:e.forEach(function(t){t.visible=!0}),this.updateSetting()},updateResizable:function(){return this.saveColumnWidth()},updateSetting:function(){return(this.$grid||this.$table).refreshColumn(),this.saveColumnHide()},handleGlobalMousedownEvent:function(t){_tools.DomTools.getEventTargetNode(t,this.$refs.customWrapper).flag||this.closeSetting()},handleGlobalBlurEvent:function(t){this.closeSetting()},handleClickSettingEvent:function(t){var e=this.settingStore;e.visible=!e.visible},handleMouseenterSettingEvent:function(t){this.settingStore.activeBtn=!0,this.openSetting()},handleMouseleaveSettingEvent:function(t){var e=this,i=this.settingStore;i.activeBtn=!1,setTimeout(function(){i.activeBtn||i.activeWrapper||e.closeSetting()},300)},handleWrapperMouseenterEvent:function(t){this.settingStore.activeWrapper=!0,this.openSetting()},handleWrapperMouseleaveEvent:function(t){var e=this,i=this.settingStore;i.activeWrapper=!1,setTimeout(function(){i.activeBtn||i.activeWrapper||e.closeSetting()},300)},btnEvent:function(t,e){var i=this.$grid;i&&(i.commitProxy(t.code),_tools.UtilTools.emitEvent(i,"toolbar-button-click",[{button:t,$grid:i},e]))}}};exports.default=_default2;
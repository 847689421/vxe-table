"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools"),_vXETable=require("../../v-x-e-table");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}var _default2={name:"VxeToolbar",props:{id:String,loading:!1,resizable:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.resizable}},refresh:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.refresh}},exps:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.exps}},setting:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.setting}},buttons:{type:Array,default:function(){return _conf.default.toolbar.buttons}},size:String,data:Array,customs:Array},inject:{$grid:{default:null}},data:function(){return{$table:null,isRefresh:!1,tableFullColumn:[],exportTypes:["csv","html"],exportModes:[{value:"all",label:"vxe.toolbar.expAll"},{value:"selected",label:"vxe.toolbar.expSelected"}],exportStore:{name:"",mode:""},exportOpts:{filename:"",type:"",original:!1,isHeader:!1},settingStore:{visible:!1}}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},refreshOpts:function(){return Object.assign({},_conf.default.toolbar.refresh,this.refresh)},expsOpts:function(){return Object.assign({},_conf.default.toolbar.exps,this.exps)},resizableOpts:function(){return Object.assign({storageKey:"VXE_TABLE_CUSTOM_COLUMN_WIDTH"},_conf.default.toolbar.resizable,this.resizable)},settingOpts:function(){return Object.assign({storageKey:"VXE_TABLE_CUSTOM_COLUMN_HIDDEN"},_conf.default.toolbar.setting,this.setting)}},created:function(){var e=this,t=this.settingOpts,o=this.id,n=this.customs;if(n&&(this.tableFullColumn=n),t.storage&&!o)return _tools.UtilTools.error("vxe.error.toolbarId");this.$nextTick(function(){e.updateConf(),e.loadStorage()}),_tools.GlobalEvent.on(this,"mousedown",this.handleGlobalMousedownEvent),_tools.GlobalEvent.on(this,"blur",this.handleGlobalBlurEvent)},destroyed:function(){_tools.GlobalEvent.off(this,"mousedown"),_tools.GlobalEvent.off(this,"blur")},render:function(l){var e,s=this,o=this._e,t=this.$scopedSlots,n=this.$grid,i=this.$table,r=this.loading,a=this.settingStore,u=this.refresh,c=this.exps,d=this.setting,f=this.settingOpts,h=this.buttons,p=void 0===h?[]:h,v=this.vSize,b=this.tableFullColumn,g={},x={},m=t.buttons,_=t.tools;return d&&("manual"===f.trigger||("hover"===f.trigger?(g.mouseenter=this.handleMouseenterSettingEvent,g.mouseleave=this.handleMouseleaveSettingEvent,x.mouseenter=this.handleWrapperMouseenterEvent,x.mouseleave=this.handleWrapperMouseleaveEvent):g.click=this.handleClickSettingEvent)),l("div",{class:["vxe-toolbar",(e={},_defineProperty(e,"size--".concat(v),v),_defineProperty(e,"is--loading",r),e)]},[l("div",{class:"vxe-button--wrapper"},m?m.call(this,{$grid:n,$table:i},l):p.map(function(t){return!1===t.visible?o():l("vxe-button",{on:{click:function(e){return s.btnEvent(e,t)}},props:{disabled:t.disabled},scopedSlots:t.dropdowns&&t.dropdowns.length?{default:function(){return _tools.UtilTools.getFuncText(t.name)},dropdowns:function(){return t.dropdowns.map(function(t){return!1===t.visible?o():l("vxe-button",{on:{click:function(e){return s.btnEvent(e,t)}},props:{disabled:t.disabled}},_tools.UtilTools.getFuncText(t.name))})}}:null},_tools.UtilTools.getFuncText(t.name))})),l("div",{class:"vxe-tools--operate"},[c?l("vxe-button",{class:"vxe-export--btn",props:{type:"text",icon:_conf.default.icon.export},on:{click:this.exportEvent}}):null,u?l("vxe-button",{class:"vxe-refresh--btn",props:{type:"text",icon:_conf.default.icon.refresh,loading:this.isRefresh},on:{click:this.refreshEvent}}):null,d?l("div",{class:["vxe-custom--wrapper",{"is--active":a.visible}],ref:"customWrapper"},[l("div",{class:"vxe-custom--setting-btn",on:g},[l("i",{class:_conf.default.icon.custom})]),l("div",{class:"vxe-custom--option-wrapper"},[l("div",{class:"vxe-custom--option",on:x},b.map(function(t){var e=t.property,o=t.visible,n=t.own,i=_tools.UtilTools.getFuncText(n.title||n.label);return e&&i?l("vxe-checkbox",{props:{value:o},attrs:{title:i},on:{change:function(e){t.visible=e,d&&f.immediate&&s.updateSetting()}}},i):null}))])]):null]),_?l("div",{class:"vxe-tools--wrapper"},_.call(this,{$grid:n,$table:i},l)):null])},methods:{updateConf:function(){var e=this.$parent,o=this.data,t=e.$children,n=t.indexOf(this);this.$table=t.find(function(e,t){return e&&e.refreshColumn&&n<t&&(o?e.data===o:"vxe-table"===e.$vnode.componentOptions.tag)})},openSetting:function(){this.settingStore.visible=!0},closeSetting:function(){var e=this.setting,t=this.settingStore;t.visible&&(t.visible=!1,e&&!t.immediate&&this.updateSetting())},loadStorage:function(){var e=this.$grid,t=this.$table,o=this.id,n=this.refresh,i=this.resizable,l=this.setting,s=this.refreshOpts,r=this.resizableOpts,a=this.settingOpts;if(n&&!e&&(s.query||_tools.UtilTools.warn("vxe.error.notFunc",["query"])),i||l){if(!e&&!t)throw new Error(_tools.UtilTools.getLog("vxe.error.barUnableLink"));(e||t).connect({toolbar:this});var u={};if(r.storage){var c=this.getStorageMap(r.storageKey)[o];c&&_xeUtils.default.each(c,function(e,t){u[t]={field:t,resizeWidth:e}})}if(a.storage){var d=this.getStorageMap(a.storageKey)[o];d&&d.split(",").forEach(function(e){u[e]?u[e].visible=!1:u[e]={field:e,visible:!1}})}var f=Object.values(u);this.updateCustoms(f.length?f:this.tableFullColumn)}},updateColumn:function(e){this.tableFullColumn=e},updateCustoms:function(e){var t=this,o=this.$grid,n=this.$table,i=o||n;i&&i.reloadCustoms(e).then(function(e){t.tableFullColumn=e})},getStorageMap:function(e){var t=_conf.default.version,o=_xeUtils.default.toStringJSON(localStorage.getItem(e));return o&&o._v===t?o:{_v:t}},saveColumnHide:function(){var e=this.id,t=this.tableFullColumn,o=this.settingOpts;if(o.storage){var n=this.getStorageMap(o.storageKey),i=t.filter(function(e){return e.property&&!e.visible});n[e]=i.length?i.map(function(e){return e.property}).join(","):void 0,localStorage.setItem(o.storageKey,_xeUtils.default.toJSONString(n))}return this.$nextTick()},saveColumnWidth:function(e){var t=this.id,o=this.tableFullColumn,n=this.resizableOpts;if(n.storage){var i,l=this.getStorageMap(n.storageKey);e||(i=_xeUtils.default.isPlainObject(l[t])?l[t]:{},o.forEach(function(e){var t=e.property,o=e.resizeWidth,n=e.renderWidth;t&&o&&(i[t]=n)})),l[t]=_xeUtils.default.isEmpty(i)?void 0:i,localStorage.setItem(n.storageKey,_xeUtils.default.toJSONString(l))}return this.$nextTick()},hideColumn:function(e){return _tools.UtilTools.warn("vxe.error.delFunc",["hideColumn","table.hideColumn"]),e.visible=!1,this.updateSetting()},showColumn:function(e){return _tools.UtilTools.warn("vxe.error.delFunc",["showColumn","table.showColumn"]),e.visible=!0,this.updateSetting()},resetCustoms:function(){return this.updateSetting()},resetResizable:function(){this.updateResizable(this)},updateResizable:function(e){var t=this.$grid,o=this.$table,n=t||o;return this.saveColumnWidth(e),n.analyColumnWidth(),n.recalculate(!0)},updateSetting:function(){return(this.$grid||this.$table).refreshColumn(),this.saveColumnHide()},handleGlobalMousedownEvent:function(e){_tools.DomTools.getEventTargetNode(e,this.$refs.customWrapper).flag||this.closeSetting()},handleGlobalBlurEvent:function(e){this.closeSetting()},handleClickSettingEvent:function(e){var t=this.settingStore;t.visible=!t.visible},handleMouseenterSettingEvent:function(e){this.settingStore.activeBtn=!0,this.openSetting()},handleMouseleaveSettingEvent:function(e){var t=this,o=this.settingStore;o.activeBtn=!1,setTimeout(function(){o.activeBtn||o.activeWrapper||t.closeSetting()},300)},handleWrapperMouseenterEvent:function(e){this.settingStore.activeWrapper=!0,this.openSetting()},handleWrapperMouseleaveEvent:function(e){var t=this,o=this.settingStore;o.activeWrapper=!1,setTimeout(function(){o.activeBtn||o.activeWrapper||t.closeSetting()},300)},refreshEvent:function(){var e=this,t=this.$grid,o=this.refreshOpts;this.isRefresh||(o.query?(this.isRefresh=!0,o.query().catch(function(e){return e}).then(function(){e.isRefresh=!1})):t&&(this.isRefresh=!0,t.commitProxy("reload").catch(function(e){return e}).then(function(){e.isRefresh=!1})))},btnEvent:function(e,t){var o=this.$grid,n=this.$table,i=t.code;if(i)if(o)o.triggerToolbarBtnEvent(t,e);else{var l=_vXETable.Buttons.get(i),s={code:i,button:t,$grid:o,$table:n};l&&l.call(this,s,e),_tools.UtilTools.emitEvent(this,"button-click",[s,e])}},exportEvent:function(){var e=this.$grid,t=this.$table,o=this.vSize,n=this.exportStore,l=this.exportOpts,s=this.exportTypes,r=this.exportModes,a=e||t,i=a.getTableColumn().fullColumn,u=a.getSelectRecords(),c=a.getVirtualScroller(),d=i.filter(function(e){return"index"===e.type||e.property&&-1===["checkbox","selection","radio"].indexOf(e.type)}),f=c.scrollX||c.scrollY;n.mode=u.length?"selected":"all",Object.assign(l,{filename:"",type:"csv",original:f,isHeader:!0}),d.forEach(function(e){e.checked="index"!==e.type}),this.$XModal({title:_conf.default.i18n("vxe.toolbar.expTitle"),width:520,mask:!0,lockView:!0,showFooter:!1,maskClosable:!0,size:o,slots:{default:function(e,i){var t=e.$modal;return[i("div",{class:"vxe-export--panel"},[i("table",{attrs:{cellspacing:0,cellpadding:0,border:0}},[i("tr",[i("td",_conf.default.i18n("vxe.toolbar.expName")),i("td",[i("input",{ref:"filename",attrs:{type:"text",placeholder:_conf.default.i18n("vxe.toolbar.expNamePlaceholder")},domProps:{value:l.filename},on:{input:function(e){l.filename=e.target.value}}})])]),i("tr",[i("td",_conf.default.i18n("vxe.toolbar.expType")),i("td",[i("select",{on:{change:function(e){l.type=e.target.value}}},s.map(function(e){return i("option",{attrs:{value:e},domProps:{selected:l.type===e}},e)}))])]),i("tr",[i("td",_conf.default.i18n("vxe.toolbar.expMode")),i("td",[i("select",{on:{change:function(e){n.mode=e.target.value}}},r.map(function(e){return i("option",{attrs:{value:e.value},domProps:{selected:n.mode===e.value}},_conf.default.i18n(e.label))}))])]),i("tr",[i("td",_conf.default.i18n("vxe.toolbar.expColumn")),i("td",[i("ul",{class:"vxe-export--panel-column"},d.map(function(e){var t=e.own,o=e.checked,n=e.type;return i("li",{class:{active:o},on:{click:function(){e.checked=!o}}},_tools.UtilTools.getFuncText(t.title||t.label||("index"===n?_conf.default.i18n("vxe.column.indexTitle"):"")))}))])]),i("tr",[i("td",_conf.default.i18n("vxe.toolbar.expOpts")),i("td",[i("vxe-checkbox",{props:{size:o},model:{value:l.isHeader,callback:function(e){l.isHeader=e}}},_conf.default.i18n("vxe.toolbar.expOptHeader")),i("vxe-checkbox",{props:{size:o,disabled:f},model:{value:l.original,callback:function(e){l.original=e}}},_conf.default.i18n("vxe.toolbar.expOptOriginal"))])])]),i("div",{class:"vxe-export--panel-btns"},[i("vxe-button",{props:{type:"primary",size:o},on:{click:function(){var e=Object.assign({columns:d.filter(function(e){return e.checked})},l);e.filename||(e.filename=_conf.default.i18n("vxe.toolbar.expTitle")),"selected"===n.mode&&(e.data=u),a.exportData(e),t.close()}}},_conf.default.i18n("vxe.toolbar.expConfirm"))])])]}},events:{show:function(e){e.$modal.$refs.filename.focus()}}})}}};exports.default=_default2;
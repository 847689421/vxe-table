"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools"),_vXETable=require("../../v-x-e-table");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var _default2={name:"VxeToolbar",props:{id:String,loading:!1,resizable:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.resizable}},refresh:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.refresh}},exps:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.exps}},setting:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.setting}},buttons:{type:Array,default:function(){return _conf.default.toolbar.buttons}},size:String,data:Array,customs:Array},inject:{$grid:{default:null}},data:function(){return{$table:null,isRefresh:!1,tableFullColumn:[],exportSuffixs:["csv"],exportTypes:[{value:"all",label:"vxe.toolbar.expAll"},{value:"selected",label:"vxe.toolbar.expSelected"}],exportStore:{name:"",suffix:"csv",type:"all"},exportOpts:{filename:"",original:!1,isHeader:!1},settingStore:{visible:!1}}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},refreshOpts:function(){return Object.assign({},_conf.default.toolbar.refresh,this.refresh)},expsOpts:function(){return Object.assign({},_conf.default.toolbar.exps,this.exps)},resizableOpts:function(){return Object.assign({storageKey:"VXE_TABLE_CUSTOM_COLUMN_WIDTH"},_conf.default.toolbar.resizable,this.resizable)},settingOpts:function(){return Object.assign({storageKey:"VXE_TABLE_CUSTOM_COLUMN_HIDDEN"},_conf.default.toolbar.setting,this.setting)}},created:function(){var e=this,t=this.settingOpts,i=this.id,o=this.customs;if(o&&(this.tableFullColumn=o),t.storage&&!i)return _tools.UtilTools.error("vxe.error.toolbarId");this.$nextTick(function(){e.updateConf(),e.loadStorage()}),_tools.GlobalEvent.on(this,"mousedown",this.handleGlobalMousedownEvent),_tools.GlobalEvent.on(this,"blur",this.handleGlobalBlurEvent)},destroyed:function(){_tools.GlobalEvent.off(this,"mousedown"),_tools.GlobalEvent.off(this,"blur")},render:function(l){var e,s=this,i=this._e,t=this.$scopedSlots,o=this.$grid,n=this.$table,r=this.loading,a=this.settingStore,u=this.refresh,c=this.exps,f=this.setting,d=this.settingOpts,h=this.buttons,p=void 0===h?[]:h,v=this.vSize,b=this.tableFullColumn,g={},x={},m=t.buttons,_=t.tools;return f&&("manual"===d.trigger||("hover"===d.trigger?(g.mouseenter=this.handleMouseenterSettingEvent,g.mouseleave=this.handleMouseleaveSettingEvent,x.mouseenter=this.handleWrapperMouseenterEvent,x.mouseleave=this.handleWrapperMouseleaveEvent):g.click=this.handleClickSettingEvent)),l("div",{class:["vxe-toolbar",(e={},_defineProperty(e,"size--".concat(v),v),_defineProperty(e,"is--loading",r),e)]},[l("div",{class:"vxe-button--wrapper"},m?m.call(this,{$grid:o,$table:n},l):p.map(function(t){return!1===t.visible?i():l("vxe-button",{on:{click:function(e){return s.btnEvent(e,t)}},props:{disabled:t.disabled},scopedSlots:t.dropdowns&&t.dropdowns.length?{default:function(){return _tools.UtilTools.getFuncText(t.name)},dropdowns:function(){return t.dropdowns.map(function(t){return!1===t.visible?i():l("vxe-button",{on:{click:function(e){return s.btnEvent(e,t)}},props:{disabled:t.disabled}},_tools.UtilTools.getFuncText(t.name))})}}:null},_tools.UtilTools.getFuncText(t.name))})),l("div",{class:"vxe-tools--operate"},[c?l("vxe-button",{class:"vxe-export--btn",props:{type:"text",icon:_conf.default.icon.export},on:{click:this.exportEvent}}):null,u?l("vxe-button",{class:"vxe-refresh--btn",props:{type:"text",icon:_conf.default.icon.refresh,loading:this.isRefresh},on:{click:this.refreshEvent}}):null,f?l("div",{class:["vxe-custom--wrapper",{"is--active":a.visible}],ref:"customWrapper"},[l("div",{class:"vxe-custom--setting-btn",on:g},[l("i",{class:_conf.default.icon.custom})]),l("div",{class:"vxe-custom--option-wrapper"},[l("div",{class:"vxe-custom--option",on:x},b.map(function(t){var e=t.property,i=t.visible,o=t.own,n=_tools.UtilTools.getFuncText(o.title||o.label);return e&&n?l("vxe-checkbox",{props:{value:i},attrs:{title:n},on:{change:function(e){t.visible=e,f&&d.immediate&&s.updateSetting()}}},n):null}))])]):null]),_?l("div",{class:"vxe-tools--wrapper"},_.call(this,{$grid:o,$table:n},l)):null])},methods:{updateConf:function(){var e=this.$parent,i=this.data,t=e.$children,o=t.indexOf(this);this.$table=t.find(function(e,t){return e&&e.refreshColumn&&o<t&&(i?e.data===i:"vxe-table"===e.$vnode.componentOptions.tag)})},openSetting:function(){this.settingStore.visible=!0},closeSetting:function(){var e=this.setting,t=this.settingStore;t.visible&&(t.visible=!1,e&&!t.immediate&&this.updateSetting())},loadStorage:function(){var e=this.$grid,t=this.$table,i=this.id,o=this.refresh,n=this.resizable,l=this.setting,s=this.refreshOpts,r=this.resizableOpts,a=this.settingOpts;if(o&&!e&&(s.query||_tools.UtilTools.warn("vxe.error.notFunc",["query"])),n||l){if(!e&&!t)throw new Error(_tools.UtilTools.getLog("vxe.error.barUnableLink"));(e||t).connect({toolbar:this});var u={};if(r.storage){var c=this.getStorageMap(r.storageKey)[i];c&&_xeUtils.default.each(c,function(e,t){u[t]={field:t,resizeWidth:e}})}if(a.storage){var f=this.getStorageMap(a.storageKey)[i];f&&f.split(",").forEach(function(e){u[e]?u[e].visible=!1:u[e]={field:e,visible:!1}})}var d=Object.values(u);this.updateCustoms(d.length?d:this.tableFullColumn)}},updateColumn:function(e){this.tableFullColumn=e},updateCustoms:function(e){var t=this,i=this.$grid,o=this.$table,n=i||o;n&&n.reloadCustoms(e).then(function(e){t.tableFullColumn=e})},getStorageMap:function(e){var t=_conf.default.version,i=_xeUtils.default.toStringJSON(localStorage.getItem(e));return i&&i._v===t?i:{_v:t}},saveColumnHide:function(){var e=this.id,t=this.tableFullColumn,i=this.settingOpts;if(i.storage){var o=this.getStorageMap(i.storageKey),n=t.filter(function(e){return e.property&&!e.visible});o[e]=n.length?n.map(function(e){return e.property}).join(","):void 0,localStorage.setItem(i.storageKey,_xeUtils.default.toJSONString(o))}return this.$nextTick()},saveColumnWidth:function(e){var t=this.id,i=this.tableFullColumn,o=this.resizableOpts;if(o.storage){var n,l=this.getStorageMap(o.storageKey);e||(n=_xeUtils.default.isPlainObject(l[t])?l[t]:{},i.forEach(function(e){var t=e.property,i=e.resizeWidth,o=e.renderWidth;t&&i&&(n[t]=o)})),l[t]=_xeUtils.default.isEmpty(n)?void 0:n,localStorage.setItem(o.storageKey,_xeUtils.default.toJSONString(l))}return this.$nextTick()},hideColumn:function(e){return _tools.UtilTools.warn("vxe.error.delFunc",["hideColumn","table.hideColumn"]),e.visible=!1,this.updateSetting()},showColumn:function(e){return _tools.UtilTools.warn("vxe.error.delFunc",["showColumn","table.showColumn"]),e.visible=!0,this.updateSetting()},resetCustoms:function(){return this.updateSetting()},resetResizable:function(){this.updateResizable(this)},updateResizable:function(e){var t=this.$grid,i=this.$table,o=t||i;return this.saveColumnWidth(e),o.analyColumnWidth(),o.recalculate(!0)},updateSetting:function(){return(this.$grid||this.$table).refreshColumn(),this.saveColumnHide()},handleGlobalMousedownEvent:function(e){_tools.DomTools.getEventTargetNode(e,this.$refs.customWrapper).flag||this.closeSetting()},handleGlobalBlurEvent:function(e){this.closeSetting()},handleClickSettingEvent:function(e){var t=this.settingStore;t.visible=!t.visible},handleMouseenterSettingEvent:function(e){this.settingStore.activeBtn=!0,this.openSetting()},handleMouseleaveSettingEvent:function(e){var t=this,i=this.settingStore;i.activeBtn=!1,setTimeout(function(){i.activeBtn||i.activeWrapper||t.closeSetting()},300)},handleWrapperMouseenterEvent:function(e){this.settingStore.activeWrapper=!0,this.openSetting()},handleWrapperMouseleaveEvent:function(e){var t=this,i=this.settingStore;i.activeWrapper=!1,setTimeout(function(){i.activeBtn||i.activeWrapper||t.closeSetting()},300)},refreshEvent:function(){var e=this,t=this.$grid,i=this.refreshOpts;this.isRefresh||(i.query?(this.isRefresh=!0,i.query().catch(function(e){return e}).then(function(){e.isRefresh=!1})):t&&(this.isRefresh=!0,t.commitProxy("reload").catch(function(e){return e}).then(function(){e.isRefresh=!1})))},btnEvent:function(e,t){var i=this.$grid,o=this.$table,n=t.code;if(n)if(i)i.triggerToolbarBtnEvent(t,e);else{var l=_vXETable.Buttons.get(n),s={code:n,button:t,$grid:i,$table:o};l&&l.call(this,s,e),_tools.UtilTools.emitEvent(this,"button-click",[s,e])}},exportEvent:function(){var e=this.$grid,t=this.$table,i=this.vSize,o=this.exportStore,l=this.exportOpts,s=this.exportSuffixs,r=this.exportTypes,a=e||t,n=a.getTableColumn().fullColumn,u=a.getSelectRecords(),c=a.getVirtualScroller(),f=n.filter(function(e){return"index"===e.type||e.property&&-1===["checkbox","selection","radio"].indexOf(e.type)});o.type=u.length?"selected":"all",Object.assign(l,{filename:"",original:c.scrollX||c.scrollY,isHeader:!0}),f.forEach(function(e){e.checked="index"!==e.type}),this.$XModal({title:_conf.default.i18n("vxe.toolbar.expTitle"),width:520,mask:!0,lockView:!0,showFooter:!1,maskClosable:!0,size:i,slots:{default:function(e,n){var t=e.$modal;return[n("div",{class:"vxe-export--panel"},[n("table",{attrs:{cellspacing:0,cellpadding:0,border:0}},[n("tr",[n("td",_conf.default.i18n("vxe.toolbar.expName")),n("td",[n("input",{attrs:{type:"text",placeholder:_conf.default.i18n("vxe.toolbar.expNamePlaceholder")},domProps:{value:l.filename},on:{input:function(e){l.filename=e.target.value}}})])]),n("tr",[n("td",_conf.default.i18n("vxe.toolbar.expSuffix")),n("td",[n("select",{on:{change:function(e){o.type=e.target.value}}},s.map(function(e){return n("option",{attrs:{value:e},domProps:{selected:o.suffix===e}},e)}))])]),n("tr",[n("td",_conf.default.i18n("vxe.toolbar.expType")),n("td",[n("select",{on:{change:function(e){o.type=e.target.value}}},r.map(function(e){return n("option",{attrs:{value:e.value},domProps:{selected:o.type===e.value}},_conf.default.i18n(e.label))}))])]),n("tr",[n("td",_conf.default.i18n("vxe.toolbar.expColumn")),n("td",[n("ul",{class:"vxe-export--panel-column"},f.map(function(e){var t=e.own,i=e.checked,o=e.type;return n("li",{class:{active:i},on:{click:function(){e.checked=!i}}},_tools.UtilTools.getFuncText(t.title||t.label||("index"===o?_conf.default.i18n("vxe.column.indexTitle"):"")))}))])]),n("tr",[n("td",_conf.default.i18n("vxe.toolbar.expOpts")),n("td",[n("vxe-checkbox",{props:{size:i},model:{value:l.isHeader,callback:function(e){l.isHeader=e}}},_conf.default.i18n("vxe.toolbar.expOptHeader")),n("vxe-checkbox",{props:{size:i},model:{value:l.original,callback:function(e){l.original=e}}},_conf.default.i18n("vxe.toolbar.expOptOriginal"))])])]),n("div",{class:"vxe-export--panel-btns"},[n("vxe-button",{props:{type:"primary",size:i},on:{click:function(){var e=Object.assign({columns:f.filter(function(e){return e.checked})},l);e.filename||(e.filename=_conf.default.i18n("vxe.toolbar.expTitle")),"selected"===o.type&&(e.data=u),a.exportCsv(e),t.close()}}},_conf.default.i18n("vxe.toolbar.expConfirm"))])])]}}})}}};exports.default=_default2;
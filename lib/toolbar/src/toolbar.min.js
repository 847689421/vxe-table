"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_vXETable=_interopRequireWildcard(require("../../v-x-e-table")),_tools=require("../../tools");function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var t=new WeakMap;return _getRequireWildcardCache=function(){return t},t}function _interopRequireWildcard(t){if(t&&t.__esModule)return t;if(null===t||"object"!==_typeof(t)&&"function"!=typeof t)return{default:t};var e=_getRequireWildcardCache();if(e&&e.has(t))return e.get(t);var o={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in t)if(Object.prototype.hasOwnProperty.call(t,s)){var r=i?Object.getOwnPropertyDescriptor(t,s):null;r&&(r.get||r.set)?Object.defineProperty(o,s,r):o[s]=t[s]}return o.default=t,e&&e.set(t,o),o}function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _defineProperty(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}var _default2={name:"VxeToolbar",props:{id:String,loading:!1,resizable:[Boolean,Object],refresh:[Boolean,Object],import:[Boolean,Object],export:[Boolean,Object],zoom:[Boolean,Object],setting:[Boolean,Object],custom:[Boolean,Object],buttons:{type:Array,default:function(){return _conf.default.toolbar.buttons}},size:String},inject:{$grid:{default:null}},data:function(){return{$table:null,isRefresh:!1,tableFullColumn:[],importStore:{file:null,type:"",filename:"",visible:!1},importParams:{mode:"",types:null,message:!0},exportStore:{name:"",mode:"",columns:[],selectRecords:[],hasFooter:!1,forceOriginal:!1,visible:!1,isTree:!1},exportParams:{filename:"",sheetName:"",type:"",types:[],original:!1,message:!0,isHeader:!1,isFooter:!1},customStore:{visible:!1}}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},refreshOpts:function(){return Object.assign({},_conf.default.toolbar.refresh,this.refresh)},importOpts:function(){return Object.assign({},_conf.default.toolbar.import,this.import)},exportOpts:function(){return Object.assign({},_conf.default.toolbar.export,this.export)},resizableOpts:function(){return Object.assign({storageKey:"VXE_TABLE_CUSTOM_COLUMN_WIDTH"},_conf.default.toolbar.resizable,this.resizable)},zoomOpts:function(){return Object.assign({},_conf.default.toolbar.zoom,this.zoom)},customOpts:function(){return Object.assign({storageKey:"VXE_TABLE_CUSTOM_COLUMN_HIDDEN"},_conf.default.toolbar.custom||_conf.default.toolbar.setting,this.custom||this.setting)}},created:function(){var t=this,e=this.customOpts,o=this.setting,i=this.id;if(e.storage&&!i)return _tools.UtilTools.error("vxe.error.toolbarId");o&&_tools.UtilTools.warn("vxe.error.delProp",["setting","custom"]),_vXETable.default._export||!this.export&&!this.import||_tools.UtilTools.error("vxe.error.reqModule",["Export"]),this.$nextTick(function(){t.updateConf(),t.loadStorage()}),_tools.GlobalEvent.on(this,"keydown",this.handleGlobalKeydownEvent),_tools.GlobalEvent.on(this,"mousedown",this.handleGlobalMousedownEvent),_tools.GlobalEvent.on(this,"blur",this.handleGlobalBlurEvent)},destroyed:function(){_tools.GlobalEvent.off(this,"keydown"),_tools.GlobalEvent.off(this,"mousedown"),_tools.GlobalEvent.off(this,"blur")},render:function(o){var t,i=this,s=this._e,e=this.$scopedSlots,r=this.$grid,n=this.$table,l=this.loading,a=this.customStore,u=this.importOpts,c=this.exportOpts,h=this.refresh,f=this.refreshOpts,d=this.zoom,p=this.zoomOpts,m=this.custom,v=this.setting,b=this.customOpts,g=this.buttons,x=void 0===g?[]:g,_=this.vSize,y=this.tableFullColumn,O=this.importStore,E=this.importParams,S=this.exportStore,$=this.exportParams,C={},T={},z=e.buttons,w=e.tools;return(m||v)&&("manual"===b.trigger||("hover"===b.trigger?(C.mouseenter=this.handleMouseenterSettingEvent,C.mouseleave=this.handleMouseleaveSettingEvent,T.mouseenter=this.handleWrapperMouseenterEvent,T.mouseleave=this.handleWrapperMouseleaveEvent):C.click=this.handleClickSettingEvent)),o("div",{class:["vxe-toolbar",(_defineProperty(t={},"size--".concat(_),_),_defineProperty(t,"is--loading",l),t)]},[o("div",{class:"vxe-button--wrapper"},z?z.call(this,{$grid:r,$table:n},o):x.map(function(e){return!1===e.visible?s():o("vxe-button",{on:{click:function(t){return i.btnEvent(t,e)}},props:{icon:e.icon,disabled:e.disabled},scopedSlots:e.dropdowns&&e.dropdowns.length?{default:function(){return _tools.UtilTools.getFuncText(e.name)},dropdowns:function(){return e.dropdowns.map(function(e){return!1===e.visible?s():o("vxe-button",{on:{click:function(t){return i.btnEvent(t,e)}},props:{icon:e.icon,disabled:e.disabled}},_tools.UtilTools.getFuncText(e.name))})}}:null},_tools.UtilTools.getFuncText(e.name))})),w?o("div",{class:"vxe-tools--wrapper"},w.call(this,{$grid:r,$table:n},o)):null,o("div",{class:"vxe-tools--operate"},[this.import?o("div",{class:"vxe-tools--operate-btn",attrs:{title:_conf.default.i18n("vxe.toolbar.import")},on:{click:this.importEvent}},[o("i",{class:u.icon||_conf.default.icon.import})]):null,this.export?o("div",{class:"vxe-tools--operate-btn",attrs:{title:_conf.default.i18n("vxe.toolbar.export")},on:{click:this.exportEvent}},[o("i",{class:c.icon||_conf.default.icon.export})]):null,h?o("div",{class:"vxe-tools--operate-btn",attrs:{title:_conf.default.i18n("vxe.toolbar.refresh")},on:{click:this.refreshEvent}},[o("i",{class:this.isRefresh?f.iconLoading||_conf.default.icon.refreshLoading:f.icon||_conf.default.icon.refresh})]):null,d&&this.$grid?o("div",{class:"vxe-tools--operate-btn",attrs:{title:_conf.default.i18n("vxe.toolbar.zoom".concat(this.$grid.isMaximized()?"Out":"In"))},on:{click:function(){return i.$grid.zoom()}}},[o("i",{class:this.$grid.isMaximized()?p.iconOut||_conf.default.icon.zoomOut:p.iconIn||_conf.default.icon.zoomIn})]):null,m||v?o("div",{class:["vxe-custom--wrapper",{"is--active":a.visible}],ref:"customWrapper"},[o("div",{class:"vxe-tools--operate-btn",attrs:{title:_conf.default.i18n("vxe.toolbar.custom")},on:C},[o("i",{class:b.icon||_conf.default.icon.custom})]),o("div",{class:"vxe-custom--option-wrapper"},[o("div",{class:"vxe-custom--option",on:T},y.map(function(e){var t=e.getTitle();return t?o("vxe-checkbox",{props:{value:e.visible,disabled:!!b.checkMethod&&!b.checkMethod({column:e})},attrs:{title:t},on:{change:function(t){e.visible=t,(m||v)&&b.immediate&&i.handleCustoms()}}},t):null}))])]):null]),_vXETable.default._export?o("vxe-import-panel",{props:{defaultOptions:E,storeData:O},on:{import:this.confirmImportEvent}}):s(),_vXETable.default._export?o("vxe-export-panel",{props:{defaultOptions:$,storeData:S},on:{print:this.confirmPrintEvent,export:this.confirmExportEvent}}):s()])},methods:{updateConf:function(){var t=this.$parent.$children,o=t.indexOf(this);this.$table=_xeUtils.default.find(t,function(t,e){return t&&t.refreshColumn&&o<e&&"vxe-table"===t.$vnode.componentOptions.tag})},openSetting:function(){this.customStore.visible=!0},closeCustom:function(){var t=this.custom,e=this.setting,o=this.customStore;o.visible&&(o.visible=!1,!t&&!e||o.immediate||this.handleCustoms())},loadStorage:function(){var t=this.$grid,e=this.$table,o=this.id,i=this.refresh,s=this.resizable,r=this.custom,n=this.setting,l=this.refreshOpts,a=this.resizableOpts,u=this.customOpts;if(i&&!t&&(l.query||_tools.UtilTools.warn("vxe.error.notFunc",["query"])),t||e)(t||e).connect({toolbar:this});else if(s||r||n)throw new Error(_tools.UtilTools.getLog("vxe.error.barUnableLink"));if(s||r||n){var c={};if(a.storage){var h=this.getStorageMap(a.storageKey)[o];h&&_xeUtils.default.each(h,function(t,e){c[e]={field:e,resizeWidth:t}})}if(u.storage){var f=this.getStorageMap(u.storageKey)[o];f&&f.split(",").forEach(function(t){c[t]?c[t].visible=!1:c[t]={field:t,visible:!1}})}var d=Object.values(c);this.updateCustoms(d.length?d:this.tableFullColumn)}},updateColumn:function(t){this.tableFullColumn=t},updateCustoms:function(t){var e=this,o=this.$grid||this.$table;o&&o.reloadCustoms(t).then(function(t){e.tableFullColumn=t})},getStorageMap:function(t){var e=_conf.default.version,o=_xeUtils.default.toStringJSON(localStorage.getItem(t));return o&&o._v===e?o:{_v:e}},saveColumnHide:function(){var t=this.id,e=this.tableFullColumn,o=this.customOpts;if(o.storage){var i=this.getStorageMap(o.storageKey),s=e.filter(function(t){return t.property&&!t.visible});i[t]=s.length?s.map(function(t){return t.property}).join(","):void 0,localStorage.setItem(o.storageKey,_xeUtils.default.toJSONString(i))}return this.$nextTick()},saveColumnWidth:function(t){var e=this.id,o=this.tableFullColumn,i=this.resizableOpts;if(i.storage){var s,r=this.getStorageMap(i.storageKey);t||(s=_xeUtils.default.isPlainObject(r[e])?r[e]:{},o.forEach(function(t){var e=t.property,o=t.resizeWidth,i=t.renderWidth;e&&o&&(s[e]=i)})),r[e]=_xeUtils.default.isEmpty(s)?void 0:s,localStorage.setItem(i.storageKey,_xeUtils.default.toJSONString(r))}return this.$nextTick()},hideColumn:function(t){return _tools.UtilTools.warn("vxe.error.delFunc",["hideColumn","table.hideColumn"]),t.visible=!1,this.handleCustoms()},showColumn:function(t){return _tools.UtilTools.warn("vxe.error.delFunc",["showColumn","table.showColumn"]),t.visible=!0,this.handleCustoms()},resetCustoms:function(){return this.handleCustoms()},resetResizable:function(){this.updateResizable(this)},updateResizable:function(t){var e=this.$grid||this.$table;return this.saveColumnWidth(t),e.analyColumnWidth(),e.recalculate(!0)},handleCustoms:function(){return(this.$grid||this.$table).refreshColumn(),this.saveColumnHide()},handleGlobalKeydownEvent:function(t){27===t.keyCode&&this.$grid&&this.$grid.isMaximized()&&this.zoomOpts&&!1!==this.zoomOpts.escRestore&&this.$grid.zoom()},handleGlobalMousedownEvent:function(t){_tools.DomTools.getEventTargetNode(t,this.$refs.customWrapper).flag||this.closeCustom()},handleGlobalBlurEvent:function(){this.closeCustom()},handleClickSettingEvent:function(){this.customStore.visible=!this.customStore.visible},handleMouseenterSettingEvent:function(){this.customStore.activeBtn=!0,this.openSetting()},handleMouseleaveSettingEvent:function(){var t=this,e=this.customStore;e.activeBtn=!1,setTimeout(function(){e.activeBtn||e.activeWrapper||t.closeCustom()},300)},handleWrapperMouseenterEvent:function(){this.customStore.activeWrapper=!0,this.openSetting()},handleWrapperMouseleaveEvent:function(){var t=this,e=this.customStore;e.activeWrapper=!1,setTimeout(function(){e.activeBtn||e.activeWrapper||t.closeCustom()},300)},refreshEvent:function(){var t=this,e=this.$grid,o=this.refreshOpts;this.isRefresh||(o.query?(this.isRefresh=!0,o.query().catch(function(t){return t}).then(function(){t.isRefresh=!1})):e&&(this.isRefresh=!0,e.commitProxy("reload").catch(function(t){return t}).then(function(){t.isRefresh=!1})))},btnEvent:function(t,e){var o=this.$grid,i=this.$table,s=e.code;if(s)if(o)o.triggerToolbarBtnEvent(e,t);else{var r=_vXETable.Buttons.get(s),n={code:s,button:e,$grid:o,$table:i};r&&r.call(this,n,t),_tools.UtilTools.emitEvent(this,"button-click",[n,t])}},importEvent:function(){if(!this.$grid&&!this.$table)throw new Error(_tools.UtilTools.getLog("vxe.error.barUnableLink"));this.openImport()},openImport:function(t){var e=this.$grid||this.$table,o=Object.assign({mode:"covering",message:!0},t,this.importOpts);!e.getTreeStatus()?(Object.assign(this.importStore,{file:null,type:"",filename:"",visible:!0}),Object.assign(this.importParams,o)):o.message&&this.$XModal.message({message:_conf.default.i18n("vxe.error.treeNotImp"),status:"error"})},confirmImportEvent:function(t){(this.$grid||this.$table).importByFile(this.importStore.file,t)},exportEvent:function(){if(!this.$grid&&!this.$table)throw new Error(_tools.UtilTools.getLog("vxe.error.barUnableLink"));this.openExport()},openExport:function(t){var e=this.customOpts,o=this.$grid||this.$table,i=o.getTableColumn().fullColumn,s=o.getTableData().footerData,r=o.getSelectRecords(),n=o.getVirtualScroller(),l=i.filter(function(t){return"seq"===t.type||"index"===t.type||t.property&&-1===["checkbox","selection","radio"].indexOf(t.type)}),a=o.getTreeStatus(),u=!!a,c=u||n.scrollX||n.scrollY,h=!!s.length,f=Object.assign({message:!0},this.exportOpts,t),d=f.types||_vXETable.default.exportTypes;return f.types=d.map(function(t){return{value:t,label:"vxe.types.".concat(t)}}),l.forEach(function(t){t.checked=t.visible,t.disabled=!!e.checkMethod&&!e.checkMethod({column:t})}),Object.assign(this.exportStore,{columns:l,selectRecords:r,mode:r.length?"selected":"all",forceOriginal:!!a||n.scrollX||n.scrollY,hasFooter:h,visible:!0,isTree:u}),Object.assign(this.exportParams,{filename:f.filename||"",sheetName:f.sheetName||"",type:f.type||f.types[0].value,types:f.types,original:c||f.original,message:f.message,isHeader:!0,isFooter:h}),this.$nextTick()},confirmPrintEvent:function(t){(this.$grid||this.$table).print(t)},confirmExportEvent:function(t){(this.$grid||this.$table).exportData(t)}}};exports.default=_default2;
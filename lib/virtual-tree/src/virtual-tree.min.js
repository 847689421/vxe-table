"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_table=_interopRequireDefault(require("../../table")),_grid=_interopRequireDefault(require("../../grid")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var propKeys=Object.keys(_table.default.props).filter(function(e){return-1===["data","treeConfig"].indexOf(e)});function countTreeExpand(e,t){var n=t[e.treeConfig.children],r=1;if(e.isTreeExpandByRow(t))for(var i=0;i<n.length;i++)r+=countTreeExpand(e,n[i]);return r}function getOffsetSize(e){switch(e.vSize){case"mini":return 3;case"small":return 2;case"medium":return 1}return 0}function calcTreeLine(e,t,n){var r=n.index,i=n.items,a=1;return r&&(a=countTreeExpand(t,i[r-1])),e.rowHeight*a-(r?1:12-getOffsetSize(t))}var _default={name:"VxeVirtualTree",extends:_grid.default,data:function(){return{removeList:[]}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},renderClass:function(){var e,t=this.tableProps,n=this.vSize,r=this.maximize,i=this.treeConfig;return["vxe-grid vxe-virtual-tree",(e={},_defineProperty(e,"size--".concat(n),n),_defineProperty(e,"t--animat",t.optimization.animat),_defineProperty(e,"has--tree-line",i&&i.line),_defineProperty(e,"is--maximize",r),e)]},tableExtendProps:function(){var t=this,n={};return propKeys.forEach(function(e){n[e]=t[e]}),n}},watch:{columns:function(e){this.loadColumn(this.handleColumns())},data:function(e){this.loadData(e)}},created:function(){var e=this.data;Object.assign(this,{fullTreeData:[],tableData:[],fullTreeRowMap:new Map}),this.handleColumns(),e&&this.reloadData(e)},methods:{renderTreeLine:function(e,t){var n=this.treeConfig,r=this.fullTreeRowMap,i=e.$table,a=e.row,s=e.column.treeNode;if(s&&n&&n.line){var l=a._X_LEVEL,o=r.get(a);return[s&&n&&n.line?t("div",{class:"vxe-tree--line-wrapper"},[t("div",{class:"vxe-tree--line",style:{height:"".concat(calcTreeLine(i,this,o),"px"),left:"".concat(l*(n.indent||20)+(l?2-getOffsetSize(this):0)+16,"px")}})]):null]}return[]},renderTreeIcon:function(e,t){var n=this,r=e.isHidden,i=e.row,a=this.treeConfig,s=a.children,l=a.indent,o=a.trigger,u=a.iconOpen,f=a.iconClose,c=i[s],h=!1,d={};return r||(h=i._X_EXPAND),o&&"default"!==o||(d.click=function(e){return n.toggleTreeExpansion(i)}),[t("span",{class:"vxe-tree--indent",style:{width:"".concat(i._X_LEVEL*(l||20),"px")}}),t("span",{class:["vxe-tree-wrapper",{"is--active":h}],on:d},c&&c.length?[t("span",{class:"vxe-tree--btn-wrapper"},[t("i",{class:["vxe-tree--node-btn",h?u||_conf.default.icon.treeOpen:f||_conf.default.icon.treeClose]})])]:[])]},_loadTreeData:function(e){var t=this;return this.$nextTick().then(function(){return t.$refs.xTable.loadData(e)})},loadData:function(e){return this._loadTreeData(this.toVirtualTree(e))},reloadData:function(e){var t=this;return this.$nextTick().then(function(){return t.$refs.xTable.reloadData(t.toVirtualTree(e))}).then(function(){return t.handleDefaultTreeExpand()})},isTreeExpandByRow:function(e){return!!e._X_EXPAND},setTreeExpansion:function(e,t){var n=this;return e&&(_xeUtils.default.isArray(e)||(e=[e]),e.forEach(function(e){return n.virtualExpand(e,!!t)})),this._loadTreeData(this.tableData)},setAllTreeExpansion:function(e){return this._loadTreeData(this.virtualAllExpand(e))},toggleTreeExpansion:function(e){return this._loadTreeData(this.virtualExpand(e,!e._X_EXPAND))},getTreeExpandRecords:function(){var t=this.hasChilds,n=[];return _xeUtils.default.eachTree(this.fullTreeData,function(e){e._X_EXPAND&&t(e)&&n.push(e)},this.treeConfig),n},clearTreeExpand:function(){return this.setAllTreeExpansion(!1)},handleColumns:function(){var n=this;return this.columns.map(function(e){if(e.treeNode){var t=e.slots||{};t.icon=n.renderTreeIcon,t.line=n.renderTreeLine,e.slots=t}return e})},hasChilds:function(e){var t=e[this.treeConfig.children];return t&&t.length},getRecordset:function(){return{insertRecords:this.getInsertRecords(),removeRecords:this.getRemoveRecords(),updateRecords:this.getUpdateRecords()}},isInsertByRow:function(e){return!!e._X_INSERT},getInsertRecords:function(){var t=[];return _xeUtils.default.eachTree(this.fullTreeData,function(e){e._X_INSERT&&t.push(e)},this.treeConfig),t},insert:function(e){return this.insertAt(e)},insertAt:function(e,t){var n=this,r=this.fullTreeData,i=this.tableData,a=this.treeConfig;_xeUtils.default.isArray(e)||(e=[e]);var s=e.map(function(e){return n.defineField(Object.assign({_X_EXPAND:!1,_X_INSERT:!0,_X_LEVEL:0},e))});if(t)if(-1===t)r.push.apply(r,s),i.push.apply(i,s);else{var l=_xeUtils.default.findTree(r,function(e){return e===t},a);if(!l||-1===l.index)throw new Error(_tools.UtilTools.error("vxe.error.unableInsert"));var o=l.items,u=l.index,f=l.nodes,c=i.indexOf(t);-1<c&&i.splice.apply(i,[c,0].concat(s)),o.splice.apply(o,[u,0].concat(s)),s.forEach(function(e){e._X_LEVEL=f.length-1})}else r.unshift.apply(r,s),i.unshift.apply(i,s);return this._loadTreeData(i).then(function(){return{row:s.length?s[s.length-1]:null,rows:s}})},getRemoveRecords:function(){return this.removeList},removeSelecteds:function(){var t=this;return this.remove(this.getSelectRecords()).then(function(e){return t.clearSelection(),e})},remove:function(e){var l=this,o=this.removeList,u=this.fullTreeData,f=this.treeConfig,c=[];return e?_xeUtils.default.isArray(e)||(e=[e]):e=u,e.forEach(function(t){var e=_xeUtils.default.findTree(u,function(e){return e===t},f);if(e){var n=e.item,r=e.items,i=e.index,a=e.parent;if(l.isInsertByRow(t)||o.push(t),a){var s=l.isTreeExpandByRow(a);s&&l.handleCollapsing(a),r.splice(i,1),s&&l.handleExpanding(a)}else l.handleCollapsing(n),r.splice(i,1),l.tableData.splice(l.tableData.indexOf(n),1);c.push(n)}}),this._loadTreeData(this.tableData).then(function(){return{row:c.length?c[c.length-1]:null,rows:c}})},handleDefaultTreeExpand:function(){var r=this,i=this.treeConfig,a=this.tableFullData;if(i){var e=i.expandAll,t=i.expandRowKeys,s=i.children;if(e)this.setAllTreeExpansion(!0);else if(t){var l=_tools.UtilTools.getRowkey(this);t.forEach(function(t){var e=_xeUtils.default.findTree(a,function(e){return t===_xeUtils.default.get(e,l)},i),n=e?e.item[s]:0;n&&n.length&&r.setTreeExpansion(e.item,!0)})}}},toVirtualTree:function(e){var s=this.fullTreeRowMap;return s.clear(),_xeUtils.default.eachTree(e,function(e,t,n,r,i,a){e._X_EXPAND=!1,e._X_INSERT=!1,e._X_LEVEL=a.length-1,s.set(e,{item:e,index:t,items:n,paths:r,parent:i,nodes:a})}),this.fullTreeData=e.slice(0),this.tableData=e.slice(0),e},virtualExpand:function(e,t){return e._X_EXPAND!==t&&(e._X_EXPAND?this.handleCollapsing(e):this.handleExpanding(e)),this.tableData},handleExpanding:function(e){if(this.hasChilds(e)){var t=this.tableData,n=this.treeConfig,r=e[n.children],s=[],i=t.indexOf(e);if(-1===i)throw new Error("错误的操作！");_xeUtils.default.eachTree(r,function(e,t,n,r,i,a){i&&!i._X_EXPAND||s.push(e)},n),e._X_EXPAND=!0,t.splice.apply(t,[i+1,0].concat(s))}return this.tableData},handleCollapsing:function(e){if(this.hasChilds(e)){var t=this.tableData,n=this.treeConfig,r=e[n.children],i=[];_xeUtils.default.eachTree(r,function(e){i.push(e)},n),e._X_EXPAND=!1,this.tableData=t.filter(function(e){return-1===i.indexOf(e)})}return this.tableData},virtualAllExpand:function(t){var n=this;return _xeUtils.default.eachTree(this.fullTreeData,function(e){n.virtualExpand(e,t)},this.treeConfig),this.tableData}}};exports.default=_default;
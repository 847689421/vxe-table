"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var scrollProcessTimeout,updateLeftScrollingTimeput,_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,o,l){return o in e?Object.defineProperty(e,o,{value:l,enumerable:!0,configurable:!0,writable:!0}):e[o]=l,e}function handleLocation(e,o,l,t,r){var n=o.indexOf(t),c=l.indexOf(r);e.active=-1<n&&-1<c,e.top=0===n&&-1<c,e.bottom=n===o.length-1&&-1<c,e.left=-1<n&&0===c,e.right=-1<n&&c===l.length-1}function isOperateMouse(e){return e._isResize||e.lastScrollTime&&Date.now()<e.lastScrollTime+300}function renderColumn(e,o,l,t,r,n,c,i,s,d,a,u,p){var f,h,m=l._e,x=l.$listeners,g=l.tableData,y=l.height,v=l.overflowX,w=l.scrollXLoad,b=l.scrollYLoad,_=l.border,T=l.highlightCurrentRow,$=l.showOverflow,I=l.showAllOverflow,P=l.align,S=l.currentColumn,C=l.cellClassName,k=l.spanMethod,L=l.keyboardConfig,R=l.radioConfig,O=void 0===R?{}:R,D=l.selectConfig,q=void 0===D?{}:D,E=l.treeConfig,H=void 0===E?{}:E,U=l.mouseConfig,M=l.editConfig,B=l.editRules,W=l.validOpts,X=l.editStore,Y=l.validStore,A=_xeUtils.default.isBoolean(I)?I:$,N=a.editRender,z=a.align,F=a.showOverflow,K=a.renderWidth,j=a.columnKey,G=X.checked,V=X.selected,J=X.actived,Q=X.copyed,Z=U&&U.selected,ee=U&&U.checked,oe=L&&L.isCut,le=n?a.fixed!==n:a.fixed&&v,te=_xeUtils.default.isUndefined(F)||_xeUtils.default.isNull(F)?A:F,re=z||P,ne="ellipsis"===te,ce="title"===te,ie=!0===te||"tooltip"===te,se=ce||ie||ne,de={},ae={},ue={},pe={},fe=Y.row===i&&Y.column===a,he=B&&("default"===W.message?y||1<g.length:"inline"===W.message),me={"data-colid":a.id},xe=N&&M&&"dblclick"===M.trigger,ge={$table:l,$seq:t,seq:r,row:i,rowIndex:s,$rowIndex:d,column:a,columnIndex:u,$columnIndex:p,fixed:n,level:c,isHidden:le,data:g};if(!w&&!b||se||(ne=se=!0),(ce||ie||x["cell-mouseenter"])&&(de.mouseenter=function(e){if(!isOperateMouse(l)){var o={$table:l,seq:r,row:i,rowIndex:s,$rowIndex:d,column:a,columnIndex:u,$columnIndex:p,fixed:n,level:c,cell:e.currentTarget};ce?_tools.DomTools.updateCellTitle(e):ie&&l.triggerTooltipEvent(e,o),_tools.UtilTools.emitEvent(l,"cell-mouseenter",[o,e])}}),(ie||x["cell-mouseleave"])&&(de.mouseleave=function(e){isOperateMouse(l)||(ie&&l.clostTooltip(),_tools.UtilTools.emitEvent(l,"cell-mouseleave",[{$table:l,seq:r,row:i,rowIndex:s,$rowIndex:d,column:a,columnIndex:u,$columnIndex:p,fixed:n,level:c,cell:e.currentTarget},e]))}),de.mousedown=function(e){l.triggerCellMousedownEvent(e,{$table:l,seq:r,row:i,rowIndex:s,$rowIndex:d,column:a,columnIndex:u,$columnIndex:p,fixed:n,level:c,cell:e.currentTarget})},(T||x["cell-click"]||N&&M||"row"===O.trigger||"radio"===a.type&&"cell"===O.trigger||"row"===q.trigger||"selection"===a.type&&"cell"===q.trigger||"row"===H.trigger||a.treeNode&&"cell"===H.trigger)&&(de.click=function(e){l.triggerCellClickEvent(e,{$table:l,row:i,rowIndex:s,$rowIndex:d,column:a,columnIndex:u,$columnIndex:p,fixed:n,level:c,cell:e.currentTarget})}),(xe||x["cell-dblclick"])&&(de.dblclick=function(e){l.triggerCellDBLClickEvent(e,{$table:l,seq:r,row:i,rowIndex:s,$rowIndex:d,column:a,columnIndex:u,$columnIndex:p,fixed:n,level:c,cell:e.currentTarget})}),k){var ye=k(ge)||{},ve=ye.rowspan,we=void 0===ve?1:ve,be=ye.colspan,_e=void 0===be?1:be;if(!we||!_e)return null;me.rowspan=we,me.colspan=_e}return!le&&M&&M.showStatus&&(h=l.hasRowChange(i,a.property)),le||n||(ee&&(handleLocation(ae,G.rows,G.columns,i,a),handleLocation(ue,G.tRows,G.tColumns,i,a)),oe&&handleLocation(pe,Q.rows,Q.columns,i,a)),e("td",{class:["vxe-body--column",a.id,(f={},_defineProperty(f,"col--".concat(re),re),_defineProperty(f,"col--edit",N),_defineProperty(f,"col--checked",ae.active),_defineProperty(f,"col--checked-top",ae.top),_defineProperty(f,"col--checked-bottom",ae.bottom),_defineProperty(f,"col--checked-left",ae.left),_defineProperty(f,"col--checked-right",ae.right),_defineProperty(f,"col--checked-temp",ue.active),_defineProperty(f,"col--checked-temp-top",ue.top),_defineProperty(f,"col--checked-temp-bottom",ue.bottom),_defineProperty(f,"col--checked-temp-left",ue.left),_defineProperty(f,"col--checked-temp-right",ue.right),_defineProperty(f,"col--selected",Z&&N&&V.row===i&&V.column===a),_defineProperty(f,"col--copyed",pe.active),_defineProperty(f,"col--copyed-top",pe.top),_defineProperty(f,"col--copyed-bottom",pe.bottom),_defineProperty(f,"col--copyed-left",pe.left),_defineProperty(f,"col--copyed-right",pe.right),_defineProperty(f,"col--ellipsis",se),_defineProperty(f,"col--actived",M&&N&&J.row===i&&(J.column===a||"row"===M.mode)),_defineProperty(f,"col--dirty",h),_defineProperty(f,"col--valid-error",fe),_defineProperty(f,"col--current",S===a),_defineProperty(f,"edit--visible",N&&"visible"===N.type),_defineProperty(f,"fixed--hidden",le),f),C?_xeUtils.default.isFunction(C)?C(ge):C:""],key:j||(l.columnKey?a.id:u),attrs:me,on:de},A&&le?[]:[e("div",{class:["vxe-cell",{"c--title":ce,"c--tooltip":ie,"c--ellipsis":ne}],style:{width:se?"".concat(_?K-1:K,"px"):null}},a.renderCell(e,ge)),he?fe?e("div",{class:"vxe-cell--valid",style:Y.rule&&Y.rule.width?{width:"".concat(Y.rule.width,"px")}:null},[e("span",{class:"vxe-cell--valid-msg"},Y.content)]):m():null,ee&&!n?e("span",{class:"vxe-body--column-checked-lt"}):null,ee&&!n?e("span",{class:"vxe-body--column-checked-rb"}):null,oe&&!n?e("span",{class:"vxe-body--column-copyed-lt"}):null,oe&&!n?e("span",{class:"vxe-body--column-copyed-rb"}):null,ae.bottom&&ae.right?e("span",{class:"vxe-body--column-checked-corner",on:{mousedown:function(e){l.triggerCornerMousedownEvent({$table:l,seq:r,row:i,rowIndex:s,$rowIndex:d,column:a,columnIndex:u,$columnIndex:p,fixed:n,level:c,cell:e.target.parentNode},e)}}}):null])}function renderRows(u,p,f,h,m,x,e,g){var y=f.rowKey,v=f.highlightHoverRow,w=f.highlightCurrentRow,b=f.rowClassName,_=f.currentRow,T=f.hoverRow,$=f.treeConfig,I=f.treeExpandeds,P=f.scrollYLoad,S=f.overflowX,o=f.columnStore,C=f.scrollYStore,k=f.editStore,L=f.expandeds,R=f.getColumnMapIndex,O=o.leftList,D=o.rightList,q=[];return e.forEach(function(t,r){var e,o={},n=r,c=n+1;P&&(c+=C.startIndex),n=f.getRowIndex(t),v&&(O.length||D.length)&&S&&(o.mouseenter=function(e){isOperateMouse(f)||t!==T&&f.triggerHoverEvent(e,{row:t,rowIndex:n})},o.mouseleave=function(e){isOperateMouse(f)||(f.hoverRow=null)});var l=_tools.UtilTools.getRowid(f,t,n);if(q.push(u("tr",{class:["vxe-body--row",(e={},_defineProperty(e,"row--level-".concat(m),$),_defineProperty(e,"row--current",w&&t===_),_defineProperty(e,"row--hover",t===T),_defineProperty(e,"row--new",-1<k.insertList.indexOf(t)),e),b?_xeUtils.default.isFunction(b)?b({$table:f,$seq:h,seq:c,fixedType:x,rowLevel:m,row:t,rowIndex:n,$rowIndex:r}):b:""],attrs:{"data-rowid":l},key:y||$?l:r,on:o},g.map(function(e,o){var l=R(e);return renderColumn(u,p,f,h,c,x,m,t,n,r,e,l,o)}))),L.length&&-1<L.indexOf(t)){var i,s=g.find(function(e){return"expand"===e.type}),d=R(s);$&&(i={paddingLeft:"".concat(m*($.indent||16)+30,"px")}),s&&q.push(u("tr",{class:"vxe-body--expanded-row",key:"expand_".concat(l),on:o},[u("td",{class:"vxe-body--expanded-column",attrs:{colspan:g.length}},[u("div",{class:"vxe-body--expanded-cell",style:i},[s.renderData(u,{$table:f,seq:c,row:t,rowIndex:n,column:s,columnIndex:d,fixed:x,level:m})])])]))}if($&&I.length){var a=t[$.children];a&&a.length&&-1<I.indexOf(t)&&q.push.apply(q,renderRows(u,p,f,h?"".concat(h,".").concat(c):"".concat(c),m+1,x,a,g))}}),q}function syncBodyScroll(e,o,l){(o||l)&&(o&&(o.onscroll=null,o.scrollTop=e),l&&(l.onscroll=null,l.scrollTop=e),clearTimeout(scrollProcessTimeout),scrollProcessTimeout=setTimeout(function(){o&&(o.onscroll=o._onscroll),l&&(l.onscroll=l._onscroll)},100))}var _default={name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,visibleColumn:Array,collectColumn:Array,fixedColumn:Array,size:String,fixedType:String,isGroup:Boolean},mounted:function(){this.$el.onscroll=this.scrollEvent,this.$el._onscroll=this.scrollEvent},beforeDestroy:function(){this.$el._onscroll=null,this.$el.onscroll=null},render:function(l){var e=this._e,o=this.$parent,t=this.fixedColumn,r=this.fixedType,n=o.maxHeight,c=o.height,i=o.containerHeight,s=o.loading,d=o.tableData,a=o.tableColumn,u=o.headerHeight,p=o.showFooter,f=o.showOverflow,h=o.showAllOverflow,m=o.footerHeight,x=o.tableHeight,g=o.tableWidth,y=o.overflowY,v=o.scrollbarHeight,w=o.scrollbarWidth,b=o.scrollXStore,_=o.scrollXLoad,T=o.scrollYStore,$=_xeUtils.default.isBoolean(h)?h:f,I="auto"===c?i:_tools.DomTools.isScale(c)?Math.floor(parseInt(c)/100*i):_xeUtils.default.toNumber(c),P={};0<I?P.height="".concat(r?(0<I?I-u-m:x)-(p?0:v):I-u-m,"px"):n&&(n=_tools.DomTools.isScale(n)?Math.floor(parseInt(n)/100*i):_xeUtils.default.toNumber(n),P["max-height"]="".concat(r?n-u-(p?0:v):n-u,"px")),r&&$?g=(a=t).reduce(function(e,o){return e+o.renderWidth},0):_&&(r&&(a=t),g=a.reduce(function(e,o){return e+o.renderWidth},0));var S={width:g?"".concat(g,"px"):g,marginTop:T.topSpaceHeight?"".concat(T.topSpaceHeight,"px"):null,marginLeft:r?null:b.leftSpaceWidth?"".concat(b.leftSpaceWidth,"px"):null};return y&&r&&(_tools.DomTools.browse["-moz"]||_tools.DomTools.browse.safari)&&(S.paddingRight="".concat(w,"px")),l("div",{class:["vxe-table--body-wrapper",r?"fixed--".concat(r,"-wrapper"):"body--wrapper"],style:P},[r?e():l("div",{class:"vxe-body--x-space",style:{width:"".concat(o.tableWidth,"px")}}),l("div",{class:"vxe-body--y-space",style:{height:"".concat(T.ySpaceHeight,"px")}}),l("table",{class:"vxe-table--body",attrs:{cellspacing:0,cellpadding:0,border:0},style:S},[l("colgroup",a.map(function(e,o){return l("col",{attrs:{name:e.id,width:e.renderWidth},key:o})})),l("tbody",renderRows(l,this,o,"",0,r,d,a))]),r||s||d.length?null:l("div",{class:"vxe-table--empty-block",style:{width:g?"".concat(g,"px"):g}},[l("span",{class:"vxe-table--empty-text"},o.$slots.empty||_conf.default.i18n("vxe.table.emptyText"))])])},methods:{scrollEvent:function(e){var o=this.$parent,l=this.fixedType,t=this.lastScrollTop,r=this.lastScrollLeft,n=o.$refs,c=o.highlightHoverRow,i=o.scrollXLoad,s=o.scrollYLoad,d=o.triggerScrollXEvent,a=o.triggerScrollYEvent,u=n.tableHeader,p=n.tableBody,f=n.leftBody,h=n.rightBody,m=u?u.$el:null,x=p.$el,g=f?f.$el:null,y=h?h.$el:null,v=x.scrollTop,w=x.scrollLeft,b=r!==w,_=t!==v;c&&o.clearHoverRow(),g&&"left"===l?syncBodyScroll(v=g.scrollTop,x,y):y&&"right"===l?syncBodyScroll(v=y.scrollTop,x,g):(m&&(m.scrollLeft=x.scrollLeft),(g||y)&&(clearTimeout(updateLeftScrollingTimeput),updateLeftScrollingTimeput=setTimeout(o.checkScrolling,_tools.DomTools.browse.msie?200:20),syncBodyScroll(v,g,y))),i&&d(e),s&&a(e),o.lastScrollTop=v,o.lastScrollLeft=w,o.lastScrollTime=Date.now(),_tools.UtilTools.emitEvent(o,"scroll",[{type:"body",fixed:l,scrollTop:v,scrollLeft:w,isX:b,isY:_,$table:o},e])}}};exports.default=_default;